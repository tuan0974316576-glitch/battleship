<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab Battleship - Final Mission</title>
    
<script type="module">
    // 1. å¼•å…¥ Firebase æ ¸å¿ƒåŠŸèƒ½
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, get, onValue, push, child, onDisconnect, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    // â˜… é—œéµï¼šé€™è£¡ä¸€æ¬¡éå¼•å…¥æ‰€æœ‰ç™»å…¥éœ€è¦çš„å·¥å…·ï¼Œç¢ºä¿å””æœƒæ¼ â˜…
    import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 2. è¨­å®š Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBdfTgb7FpkYdgjvrYWQ0jr-N-1fAaW9Q0",
        authDomain: "vocabularyxdungeon.firebaseapp.com",
        databaseURL: "https://vocabularyxdungeon-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "vocabularyxdungeon",
        storageBucket: "vocabularyxdungeon.appspot.com",
        messagingSenderId: "834761939928",
        appId: "1:834761939928:web:4591dcd9650ec99746f0ad"
    };

    // 3. å•Ÿå‹• Firebase ä¸¦æ›è¼‰åˆ° window (è®“å…¨åŸŸå¯ç”¨)
    // é€™è£¡æˆ‘å€‘å»ºç«‹ä¸€å€‹å®Œæ•´çš„å·¥å…·åŒ…ï¼Œä¹‹å¾Œå¯« Login åŠŸèƒ½å°±å””ä½¿å†æ”¹é€™è£¡
    const app = initializeApp(firebaseConfig);
    
    window.firebaseModules = {
        app,
        getDatabase, ref, set, update, get, onValue, push, child, onDisconnect, off,
        getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
    };
    
    // åˆå§‹åŒ–å…¨åŸŸè®Šæ•¸
    window.db = getDatabase(app);
    window.auth = getAuth(app);

    console.log("ğŸ”¥ Step 1 å®Œæˆï¼šFirebase å·²é€£ç·šï¼Œå·¥å…·åŒ…å·²æº–å‚™å¥½ï¼");
</script>

    <style>
@import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Orbitron:wght@400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --primary: #0ea5e9; 
            --danger: #ef4444;  
            --success: #22c55e; 
            --warning: #f59e0b;
            --text: #e2e8f0;
            --glass-border: rgba(255, 255, 255, 0.2);
        }

body {
            background-color: #000;
            background-image: url('stars_texture.jpg'), url('stars_texture.png'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            
            /* â˜… é‡é»ä¿®æ”¹ï¼šå…¨å±€æ”¹ç”¨ Orbitron â˜… */
            font-family: 'Orbitron', sans-serif; 
            letter-spacing: 1px; /* åŠ é—Šå°‘å°‘å­—è·ï¼Œæ›´æœ‰ç§‘æŠ€æ„Ÿ */
            
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            position: relative;
            user-select: none;
        }

        /* Galaxy èƒŒæ™¯ */
        body::before {
            content: "";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85vmin; height: 85vmin;
            background-image: url('galaxy.jpg'), url('galaxy.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            mix-blend-mode: screen; 
            opacity: 0.8; 
            z-index: -1;
            animation: rotateGalaxy 120s linear infinite;
        }

        @keyframes rotateGalaxy {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* --- æ¨™é¡Œç•«é¢ (Start Screen) --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.6); transition: opacity 0.5s;
        }

        .main-title {
            font-family: 'Black Ops One', cursive;
            font-size: 60px;
            color: var(--primary);
            text-shadow: 0 0 20px var(--primary);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 5px;
            animation: floatTitle 3s ease-in-out infinite;
        }

        @keyframes floatTitle {
            0%, 100% { transform: translateY(0); text-shadow: 0 0 20px var(--primary); }
            50% { transform: translateY(-10px); text-shadow: 0 0 40px var(--primary); }
        }

        .start-btn-large {
            padding: 15px 40px;
            font-size: 24px;
            background: rgba(14, 165, 233, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
            font-family: 'Black Ops One';
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px var(--success);
            text-transform: uppercase;
        }

        .start-btn-large:hover {
            background: var(--success);
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--success);
        }

        /* --- éŠæˆ²ä»‹é¢ (Game UI) --- */
        #game-ui {
            display: none; 
            width: 100%;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 1s;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        #control-panel {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--primary);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 20;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.3);
            transition: all 0.3s;
            margin-top: 20px;
        }

.btn {
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid var(--primary);
            color: #fff;
            padding: 5px 15px;
            cursor: pointer;
            
            /* â˜… æ”¹ç”¨ Orbitronï¼ŒåŠ ç²— â˜… */
            font-family: 'Orbitron', sans-serif;
            font-weight: 700; 
            
            transition: 0.2s;
        }
        .btn:hover { background: var(--primary); color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; background: transparent; color: #555; }

        /* --- æ£‹ç›¤å®¹å™¨ --- */
        .board-container {
            display: none; 
            position: relative;
            margin: 10px;
            z-index: 10;
        }
        
        .board-container.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .board-label {
            text-align: center;
            font-family: 'Black Ops One';
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px currentColor;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr); 
            gap: 2px;
            background: rgba(255, 255, 255, 0.02); 
            backdrop-filter: blur(2px);
            padding: 10px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(14, 165, 233, 0.15);
            position: relative;
        }

        #enemy-board .game-grid { border-color: var(--danger); box-shadow: 0 0 40px rgba(239, 68, 68, 0.15); }

        .cell {
            width: 35px; height: 35px;
            background-color: rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(14, 165, 233, 0.2); 
            border-radius: 4px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; position: relative;
        }

        #enemy-board .cell { border-color: rgba(239, 68, 68, 0.3); }
        .cell.valid-hover { background-color: rgba(34, 197, 94, 0.5) !important; }
        .cell.invalid-hover { background-color: rgba(239, 68, 68, 0.5) !important; }
        
        .cell.hit { background-color: rgba(239, 68, 68, 0.8) !important; border-color: var(--danger); text-shadow: 0 0 5px #fff; }
        
        .cell.miss { 
            background-color: rgba(255, 255, 255, 0.05) !important; /* æ¥µæ·¡çš„åº•è‰² */
            color: rgba(255, 255, 255, 0.3); /* 30% é€æ˜åº¦çš„ç™½è‰² */
            font-family: sans-serif; font-size: 28px; font-weight: bold;
            text-shadow: none; cursor: default;
        }
        
        .cell.revealed { cursor: default; }

        .ship-overlay {
            position: absolute; pointer-events: none; z-index: 6;
            transition: all 0.3s ease; filter: drop-shadow(0 0 5px cyan);
            image-rendering: pixelated; 
        }

        /* --- å‹•ç•«ç‰¹æ•ˆ --- */
        .anim-blue {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20;
            background-image: url('turret_02_explosion_01_anim.png'); 
            background-repeat: no-repeat;
            background-size: 700% 100%; /* 7æ ¼åœ– */
            animation: playBlue 0.5s steps(6) forwards;
            image-rendering: pixelated; pointer-events: none;
        }
        @keyframes playBlue { from { background-position: 0 0; } to { background-position: 100% 0; } }

        .anim-orange {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 21;
            background-image: url('turret_01_explosion.png'); 
            background-repeat: no-repeat;
            background-size: 500% 100%; /* 5æ ¼åœ– */
            animation: playOrange 0.5s steps(4) forwards;
            image-rendering: pixelated; pointer-events: none;
        }
        @keyframes playOrange { from { background-position: 0 0; } to { background-position: 100% 0; } }

        /* --- Modal (è§£ç¢¼è¦–çª—) --- */
/* --- Modal (è§£ç¢¼è¦–çª—) - é›»è…¦ç‰ˆé è¨­ (ä¿æŒç½®ä¸­) --- */
    #launch-modal { 
        display: none; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        
        /* â˜… é›»è…¦ç‰ˆè¨­å®šï¼šä¿æŒæ°´å¹³å‚ç›´å®Œç¾ç½®ä¸­ â˜… */
        justify-content: center; 
        align-items: center; 
        padding-top: 0; /* é›»è…¦ç‰ˆå””ä½¿ç•™ç©º */
        
        backdrop-filter: blur(10px); 
    }
        
        .modal-content { 
            background: rgba(15, 23, 42, 0.95); 
            border: 2px solid var(--danger); 
            border-radius: 15px; 
            padding: 30px; 
            width: 90%; 
            max-width: 420px; 
            text-align: center; 
            box-shadow: 0 0 60px rgba(239, 68, 68, 0.6); 
            position: relative;
        }

.vocab-hint { 
            font-size: 36px; letter-spacing: 8px; color: var(--primary); margin: 20px 0; 
            
            /* â˜… æ”¹ç”¨ Orbitron â˜… */
            font-family: 'Orbitron', sans-serif; 
            
            font-weight: bold; text-transform: uppercase;
            text-shadow: 0 0 10px var(--primary); min-height: 50px;
        }

        #hidden-input { position: absolute; opacity: 0; top: 0; left: 0; height: 100%; width: 100%; cursor: default; }
        #timer-bar-container { width: 100%; height: 6px; background: #334155; border-radius: 3px; margin-top: 20px; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: linear-gradient(90deg, #ef4444, #f87171); transition: width 1s linear; }

        #warning-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; pointer-events: none;
            box-shadow: inset 0 0 100px rgba(255,0,0,0.5); display: none; z-index: 50;
            animation: pulseWarning 1s infinite;
        }
        @keyframes pulseWarning { 0% { opacity: 0.2; } 50% { opacity: 0.8; } 100% { opacity: 0.2; } }

        @media (max-width: 500px) {
            .cell { width: 8vw; height: 8vw; max-width: 35px; max-height: 35px; } 
            .main-title { font-size: 36px; }
            #control-panel { flex-direction: column; gap: 5px; }
            .vocab-hint { font-size: 28px; letter-spacing: 4px; }
        }
/* --- è‰¦éšŠå´é‚Šæ¬„ --- */
#fleet-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px; /* èˆ¹èˆ‡èˆ¹ä¹‹é–“çš„è·é›¢ */
            background: rgba(15, 23, 42, 0.8);
            padding: 20px 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            min-width: 80px;
            align-items: center;
        }
.fleet-unit {
            position: relative;
            display: grid; /* ç”¨ Grid æ’åˆ—èƒŒæ™¯æ ¼ä»” */
            gap: 2px;      /* æ ¼ä»”ä¹‹é–“çš„ç©ºéš™ */
            transition: all 0.3s;
            padding: 3px;
            border: 2px solid transparent;
            border-radius: 4px;
        }
.fleet-ship-img {
            position: absolute;
            top: 3px;  /* å°æ‡‰ .fleet-unit çš„ padding */
            left: 3px;
            width: calc(100% - 6px); /* æ‰£é™¤ padding */
            height: calc(100% - 6px);
            z-index: 2; /* ç¢ºä¿åœ¨æ ¼ä»”ä¸Šé¢ */
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
            filter: drop-shadow(0 0 2px #000);
        }
.mini-cell {
            width: 25px;  /* è¿·ä½ æ ¼å¤§ç´° */
            height: 25px;
            background-color: rgba(255, 255, 255, 0.1); /* åŠé€æ˜åº• */
            border: 1px solid rgba(255, 255, 255, 0.3); /* é‚Šæ¡† */
            border-radius: 2px;
        }
        .ship-preview {
            transition: all 0.3s;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 2px;
            background: rgba(255,255,255,0.05);
        }

        /* ç‹€æ…‹ 1: æ­£æº–å‚™æ”¾ (Active) - ç™¼å…‰ + æ”¾å¤§ */
.fleet-unit.current {
            border-color: var(--warning);
            box-shadow: 0 0 15px var(--warning);
            background: rgba(245, 158, 11, 0.1);
            transform: scale(1.1);
        }
.fleet-unit.current .mini-cell {
            background-color: rgba(245, 158, 11, 0.3); /* æ ¼ä»”è®Šé»ƒ */
            border-color: var(--warning);
        }
        /* ç‹€æ…‹ 2: æœªè¼ªåˆ° (Pending) - å¯¦è‰²ä½†æš—å°‘å°‘ */
.fleet-unit.pending {
            opacity: 0.6;
            transform: scale(0.95);
        }

        /* ç‹€æ…‹ 3: å·²éƒ¨ç½² (Deployed) - å‰ªå½±/é»‘ç™½/é€æ˜ */
.fleet-unit.deployed {
            opacity: 0.3;
            filter: grayscale(100%);
            transform: scale(0.8);
        }
/* --- å…¨å±€è¿”å›æŒ‰éˆ•æ¨£å¼ --- */
        #global-back-btn {
            display: none; /* ä¸€é–‹å§‹ä¿‚ Start Screenï¼Œæ‰€ä»¥é è¨­éš±è— */
            position: fixed;
            bottom: 30px; /* è·é›¢åº•éƒ¨ */
            left: 50%;
            transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */
            
            /* High-Tech é€æ˜é¢¨æ ¼ */
            background: transparent;
            color: var(--primary); /* ç”¨ä½ çš„ä¸»è‰²èª¿ (é’è—è‰²) */
            border: 2px solid var(--primary);
            padding: 10px 30px;
            font-family: 'Black Ops One', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            cursor: pointer;
            z-index: 1000; /* ç¢ºä¿åœ¨æœ€é ‚å±¤ */
            
            /* ç™¼å…‰ç‰¹æ•ˆ */
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
            text-shadow: 0 0 5px var(--primary);
            transition: all 0.3s ease;
        }

        #global-back-btn:hover {
            background: rgba(14, 165, 233, 0.2); /* Hover æ™‚åŠ å°‘å°‘åº•è‰² */
            box-shadow: 0 0 20px var(--primary); /* ç™¼å…‰æ›´å¼· */
            transform: translateX(-50%) scale(1.1); /* æ”¾å¤§å°‘å°‘ */
            color: #fff;
        }
/* --- é«˜ç§‘æŠ€ç¢ºèªè¦–çª—æ¨£å¼ --- */
        .tech-modal-overlay {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; /* æœ€æœ€é ‚å±¤ */
            align-items: center; justify-content: center; 
            backdrop-filter: blur(5px);
        }

        .tech-modal-box {
            background: rgba(15, 23, 42, 0.95); 
            border: 2px solid var(--danger); /* ç´…è‰²é‚Šæ¡† */
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.4); /* ç´…è‰²å…‰æšˆ */
            padding: 30px; 
            text-align: center; 
            border-radius: 10px;
            max-width: 450px; 
            width: 90%;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .tech-warning-title {
            font-family: 'Black Ops One'; 
            color: var(--danger); 
            font-size: 30px;
            margin-bottom: 15px; 
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--danger);
        }

        .tech-warning-msg {
            color: #cbd5e1; 
            font-family: 'Roboto Mono'; 
            margin-bottom: 30px; 
            font-size: 14px;
            line-height: 1.5;
            font-weight: bold;
        }

        .tech-btn-group { 
            display: flex; 
            gap: 20px; 
            justify-content: center; 
        }

        .tech-btn {
            flex: 1; 
            padding: 12px; 
            font-family: 'Black Ops One'; 
            font-size: 16px;
            cursor: pointer;
            border: 1px solid; 
            transition: all 0.2s;
            text-transform: uppercase;
        }

        /* å–æ¶ˆæ£æ¨£å¼ */
        .tech-btn.cancel { 
            border-color: var(--primary); 
            color: var(--primary); 
            background: transparent; 
        }
        .tech-btn.cancel:hover { 
            background: var(--primary); 
            color: #000; 
            box-shadow: 0 0 15px var(--primary);
        }

        /* ç¢ºèªæ£æ¨£å¼ (å±éšª) */
        .tech-btn.confirm { 
            border-color: var(--danger); 
            color: var(--danger); 
            background: transparent; 
        }
        .tech-btn.confirm:hover { 
            background: var(--danger); 
            color: #fff; 
            box-shadow: 0 0 20px var(--danger);
            transform: scale(1.05);
        }

        @keyframes popIn { 
            from { transform: scale(0.8); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
/* --- æœªä¾†æ„Ÿè¼¸å…¥æ¡†æ¨£å¼ --- */
       /* --- æœªä¾†æ„Ÿè¼¸å…¥æ¡†æ¨£å¼ (Orbitron ç‰ˆ) --- */
        #room-id-input {
            background: rgba(0, 0, 0, 0.8); 
            border: 2px solid var(--primary); /* é’è—è‰²é‚Šæ¡† */
            padding: 15px; 
            color: var(--primary); 
            text-align: center; 
            width: 260px; /* ç¨å¾®æ•´é—Šå°‘å°‘ï¼Œå› ç‚º Orbitron å­—æ¯”è¼ƒé—Š */
            margin-bottom: 15px;
            border-radius: 5px;
            
            /* â˜… é‡é»ï¼šæ”¹ç”¨ Orbitron å­—é«” â˜… */
            font-family: 'Orbitron', sans-serif;
            font-weight: 700; /* ç²—é«”æ•¸å­—å¥½ç‡å•² */
            font-size: 28px; 
            letter-spacing: 4px; /* å­—è· */
            
            /* ç™¼å…‰ç‰¹æ•ˆ */
            text-shadow: 0 0 10px var(--primary); 
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2); 
            outline: none; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ç•¶è¼¸å…¥æ¡†è¢«é»æ“Šæ™‚ (Focus) */
        #room-id-input:focus {
            border-color: var(--warning); /* è®Šæˆè­¦å‘Šé»ƒ */
            color: var(--warning);
            text-shadow: 0 0 15px var(--warning);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            transform: scale(1.05);
        }

        /* ä¿®æ”¹ Placeholder (ENTER ROOM ID) */
        #room-id-input::placeholder {
            color: rgba(14, 165, 233, 0.4); 
            
            /* â˜… Placeholder éƒ½ç”¨åŸ‹ Orbitronï¼Œä½†å¹¼èº«å•² â˜… */
            font-family: 'Orbitron', sans-serif;
            font-weight: 500; 
            font-size: 14px; /* ç¸®ç´°å°‘å°‘ï¼Œè²»äº‹åŒè¼¸å…¥å˜…æ•¸å­—æ¶é¡ */
            letter-spacing: 2px;
            text-shadow: none;
        }
/* --- é¡Œç›®æ–‡å­— (ç™¼å…‰ç‰¹æ•ˆ) --- */
        #q-text {
            font-size: 32px; /* åŠ å¤§å­—é«” */
            margin: 15px 0;
            color: #fff;
            font-weight: 900; /* æœ€ç²—é«” */
            
            /* é›–ç„¶ä¸­æ–‡å­—å‹ç„¡ Orbitronï¼Œä½†è‹±æ–‡/æ¨™é»æœƒè®Š Orbitronï¼Œæ··åˆèµ·ä¾†å¥½ç‡ */
            font-family: 'Orbitron', sans-serif; 
            
            /* â˜… é—œéµï¼šé›™é‡ç™¼å…‰ç‰¹æ•ˆ â˜… */
            text-shadow: 
                0 0 10px var(--primary), 
                0 0 20px var(--primary),
                0 0 40px var(--primary);
                
            letter-spacing: 2px; /* å­—è·æ‹‰é—Šå°‘å°‘ */
        }
/* --- START BATTLE æŒ‰éˆ•ç‰¹æ•ˆ (ç•¶å¯ä»¥æŒ‰çš„æ™‚å€™) --- */
        #start-btn:not(:disabled) {
            /* è®Šæ›´åº•è‰²ç‚ºæ©™è‰²æ¼¸è®Š */
            background: linear-gradient(45deg, rgba(245, 158, 11, 0.4), rgba(0, 0, 0, 0.6));
            border: 2px solid var(--warning);
            color: var(--warning);
            
            /* å­—é«”å‡ç´š */
            font-family: 'Black Ops One', cursive; 
            font-size: 22px; 
            letter-spacing: 2px;
            padding: 5px 30px; /* åŠ é—ŠæŒ‰éˆ• */
            
            /* å¼·çƒˆç™¼å…‰å‹•ç•« (å‘¼å¸ç‡ˆ) */
            animation: readyPulse 0.8s infinite alternate;
            
            cursor: pointer;
            z-index: 100;
        }

        /* å‘¼å¸ç‡ˆå‹•ç•« Keyframes */
        @keyframes readyPulse {
            from {
                transform: scale(1);
                box-shadow: 0 0 10px var(--warning);
                text-shadow: 0 0 5px var(--warning);
                border-color: var(--warning);
            }
            to {
                transform: scale(1.1); /* æ”¾å¤§ 1.1 å€ */
                box-shadow: 0 0 40px var(--warning), 0 0 20px var(--warning) inset; /*å…§å¤–ç™¼å…‰*/
                text-shadow: 0 0 20px var(--warning);
                border-color: #fff; /* é‚Šæ¡†é–ƒç™½å…‰ */
            }
        }
/* --- æˆ°è‰¦æ®˜éª¸ (æ“Šæ²‰å¾Œé¡¯ç¤º) --- */
        .enemy-ship-revealed {
            position: absolute;
            z-index: 5; 
            pointer-events: none;
            
            /* è¨­å®šæœ€çµ‚ç‹€æ…‹ */
            opacity: 0.9; 
            filter: drop-shadow(0 0 15px var(--danger)); /* ç´…è‰²æˆ°æå…‰æšˆ */
            
            /* æ’­æ”¾å‹•ç•«ï¼š0.5ç§’ */
            animation: shipMaterialize 0.5s ease-out forwards;
        }

        /* â˜… æ–°å‹•ç•«ï¼šå…¨æ¯æŠ•å½±é–ƒç¾æ•ˆæœ â˜… */
        /* ä¸å†æ”¹è®Š transformï¼Œæ‰€ä»¥ä¸æœƒå½±éŸ¿ JS çš„æ—‹è½‰è¨­å®š */
        @keyframes shipMaterialize {
            0% { 
                opacity: 0; 
                filter: drop-shadow(0 0 0 var(--danger)) brightness(5); /* ä¸€é–‹å§‹è¶…å…‰ (é–ƒå…‰) */
            }
            100% { 
                opacity: 0.9; 
                filter: drop-shadow(0 0 15px var(--danger)) brightness(1); /* è®Šå›æ­£å¸¸ */
            }
        }
/* --- æ•µè»è‰¦éšŠç‹€æ…‹æ¬„ --- */
/* --- å‡ç´šç‰ˆç‹€æ…‹é¢æ¿ (Status Panel) --- */
        #status-panel {
            display: flex;
            justify-content: space-between; /* å·¦å³æ’é–‹ */
            align-items: center;
            background: rgba(15, 23, 42, 0.85); /* æ·±è—é»‘åº• */
            border: 1px solid var(--danger); /* ç´…è‰²é‚Šæ¡† */
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 5px 15px;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.15) inset;
            min-height: 50px;
            position: relative;
        }

        /* å·¦é‚Šï¼šè‰¦éšŠå®¹å™¨ */
        #enemy-fleet-indicator {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-grow: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            justify-content: center;
        }

/* --- 2.0 ç‰ˆï¼šçœŸå¯¦å½¢ç‹€èƒ½é‡æ–¹å¡Š --- */
        
        /* æ¯ä¸€æ•´éš»èˆ¹çš„å®¹å™¨ (æ”¹ç”¨ Grid ä½ˆå±€) */
        .enemy-ship-block {
            display: grid; /* â˜… é—œéµï¼šç”¨ Grid ä¾†æ’å½¢ç‹€ */
            gap: 2px;      /* æ–¹å¡Šä¹‹é–“çš„ç©ºéš™ (æ•´å¯†å°‘å°‘) */
            padding: 4px;
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            /* è®“èˆ¹éš»åœ¨å®¹å™¨å…§å‚ç›´ç½®ä¸­ */
            align-self: center; 
        }

        /* å–®å€‹èƒ½é‡æ–¹å¡Š (å¯¦å¿ƒ = ç”Ÿå­˜) */
        .indicator-cell {
            width: 8px;   /* â˜… æ”¹ç´°å°‘å°‘ï¼Œå› ç‚º 2x4 èˆ¹æœƒå¥½å¤§èˆŠ */
            height: 8px;
            background-color: var(--warning); 
            border-radius: 1px; 
            box-shadow: 0 0 5px var(--warning); 
            transition: all 0.3s ease;
        }

        /* å–®å€‹èƒ½é‡æ–¹å¡Š (ç©ºå¿ƒ = è¢«æ¯€) */
        .indicator-cell.cell-destroyed {
            background-color: transparent; 
            border: 1px solid var(--warning); 
            box-shadow: none; 
            opacity: 0.4; 
        }

        /* â˜… æ–°å¢ï¼šé€æ˜ä½”ä½æ ¼ (ç”¨æ–¼ Tå‹èˆ¹çš„ç©ºä½) â˜… */
        .indicator-cell.cell-empty {
            background: transparent;
            box-shadow: none;
            border: none;
        }

        /* ä¸­é–“ï¼šåˆ†éš”ç·š */
        .panel-divider {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 15px;
        }

        /* å³é‚Šï¼šå›åˆæ•¸ */
        #turn-display {
            text-align: center;
            min-width: 50px;
        }

#turn-count {
            /* æ”¹ç”¨ Orbitron */
            font-family: 'Orbitron', sans-serif;
            /* ç”¨ç²—é«” (700) å¢åŠ ä»½é‡ï¼Œå¦‚æœè¦ºå¾—å¤ªç²—å¯ä»¥æ”¹ç•ªåš 500 */
            font-weight: 700; 
            font-size: 32px; /* å­—é«”ç¨å¾®åŠ å¤§ */
            color: var(--warning);
            /* ç²¾ç´°åŒ–ç™¼å…‰æ•ˆæœï¼Œä»¤é‚Šç·£æ›´éŠ³åˆ© */
            text-shadow: 0 0 5px var(--warning), 0 0 15px rgba(245, 158, 11, 0.4);
            line-height: 1;
            letter-spacing: 1px;
        }
/* --- æ‰‹æ©Ÿ/å¹³æ¿ éŸ¿æ‡‰å¼ä½ˆå±€ --- */
    @media (max-width: 768px) {
        /* 1. å°‡ã€Œå·¦å³ä½ˆå±€ã€æ”¹ç‚ºã€Œä¸Šä¸‹ä½ˆå±€ã€ */
        .fleet-main-layout {
            flex-direction: column !important; /* å‚ç›´æ’åˆ— */
            align-items: center !important;
        }

        /* 2. å°‡å´é‚Šæ¬„æ”¹ç‚ºã€Œæ©«å‘æ’åˆ—ã€ä¸¦æ”¾åœ¨é ‚éƒ¨ */
        #fleet-sidebar {
            flex-direction: row !important; /* æ©«æ’ */
            width: 100%;      /* ä½”æ»¿é—Šåº¦ */
            max-width: 380px; /* å””å¥½å¤ªé—Š */
            overflow-x: auto; /* å¦‚æœå¤ªå¤šèˆ¹ï¼Œå®¹è¨±å·¦å³æ»‘å‹• */
            margin-bottom: 15px; /* åŒæ£‹ç›¤ä¿æŒè·é›¢ */
            padding: 10px 5px;
            gap: 8px; /* èˆ¹èˆ‡èˆ¹ä¹‹é–“å¯†å°‘å°‘ */
            min-width: auto; /* å–æ¶ˆæœ€å°é—Šåº¦é™åˆ¶ */
            justify-content: center; /* å±…ä¸­ */
        }

        /* 3. èª¿æ•´æ¯éš»èˆ¹ä»”çš„å¤§å° (ç¨å¾®ç¸®ç´°ä»¥é©æ‡‰æ©«æ’) */
        .fleet-unit {
            transform: scale(0.85); /* ç¸®ç´° 85% */
            margin: 0; 
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“æ‰ */
        }
        
        /* é¸ä¸­æ™‚çš„æ”¾å¤§æ•ˆæœç¨å¾®æ”¶æ–‚ï¼Œè²»äº‹çˆ†ä½ */
        .fleet-unit.current {
            transform: scale(0.95); 
        }
    }
/* --- æ‰‹æ©Ÿ / iPad å°ˆç”¨èª¿æ•´ (ç•¶è¢å¹•é—Šåº¦ç´°é 1024px) --- */
    @media (max-width: 1024px) { 
        #launch-modal {
            /* â˜… æ‰‹æ©Ÿç‰ˆå¼·åˆ¶è¦†å¯«ï¼šæ”¹ç‚ºé ä¸Š â˜… */
            align-items: flex-start !important; 
            
            /* â˜… ä¸Šæ–¹ç•™ç©º 15%ï¼Œé¿é–‹é ‚éƒ¨è³‡è¨Šæ¬„ï¼ŒåŒåŸ‹é ç•™ç©ºé–“ä¿¾éµç›¤æ¨èµ· â˜… */
            padding-top: 15vh !important; 
            
            /* é˜²æ­¢å…§å®¹å¤ªé•·æ™‚è¢«åˆ‡æ–· */
            overflow-y: auto; 
        }
        
        /* é‡å°æ‰‹æ©Ÿç‰ˆæ¡†æ¡†çš„å¤§ç´°èª¿æ•´ */
        .modal-content {
            width: 90%;
            max-width: 400px;
            /* åº•éƒ¨åŠ å¤šå•² Bufferï¼Œç¢ºä¿éµç›¤å½ˆèµ·æ™‚å””æœƒé ‚æ­»å€‹æ¡† */
            margin-bottom: 20vh; 
        }
    }
        /* --- ç­‰ç´šé¸æ“‡ç•«é¢æ¨£å¼ --- */
/* --- ç­‰ç´šé¸æ“‡ç•«é¢æ¨£å¼ --- */
    .level-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* å¼·åˆ¶å…©åˆ— */
        gap: 20px;
        width: 90%;
        max-width: 400px; /* ç¨å¾®ç¸®çª„ä¸€é»ï¼Œè®“æŒ‰éˆ•çœ‹èµ·ä¾†æ›´ç·Šæ¹Š */
    }

    .level-btn {
        background: rgba(15, 23, 42, 0.8);
        border: 2px solid var(--primary);
        color: #fff;
        padding: 15px; /* èª¿æ•´é«˜åº¦ */
        font-family: 'Orbitron', sans-serif;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        text-shadow: 0 0 5px var(--primary);
        box-shadow: 0 0 10px rgba(14, 165, 233, 0.2);
        
        /* ç¢ºä¿æ–‡å­—ç½®ä¸­ */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .level-btn:hover {
        background: var(--primary);
        color: #000;
        transform: scale(1.05);
        box-shadow: 0 0 20px var(--primary);
    }
    .start-btn-large[onclick*="PVP"] {
        animation: pvpReadyPulse 1.5s infinite alternate;
    }

    @keyframes pvpReadyPulse {
        from {
            box-shadow: 0 0 10px var(--warning);
            text-shadow: 0 0 5px var(--warning);
        }
        to {
            box-shadow: 0 0 25px var(--warning), 0 0 10px var(--warning) inset;
            text-shadow: 0 0 15px var(--warning);
        }
    }
        /* --- VS PLAYER æŒ‰éˆ•å°ˆå±¬æ¨£å¼ --- */
    .btn-pvp {
        border-color: var(--warning) !important;
        color: var(--warning) !important;
        box-shadow: 0 0 15px var(--warning);
        text-shadow: 0 0 5px var(--warning);
        background: rgba(245, 158, 11, 0.1); /* é è¨­æ·¡æ·¡çš„æ©™è‰²èƒŒæ™¯ */
    }

    /* â˜… ä¿®æ­£é‡é»ï¼šHover æ™‚ä¸­é–“è®Šæ©™è‰²ï¼Œå­—è®Šç™½è‰² â˜… */
    .btn-pvp:hover {
        background: var(--warning) !important;
        color: #fff !important; /* æ–‡å­—è®Šç™½è‰² */
        transform: scale(1.1);
        box-shadow: 0 0 30px var(--warning);
        text-shadow: none; /* å¯¦è‰²èƒŒæ™¯ä¸‹ä¸éœ€è¦æ–‡å­—ç™¼å…‰ */
    }

    /* ä¿æŒä½ çš„å‘¼å¸ç‡ˆå‹•ç•« */
    .btn-pvp {
        animation: pvpReadyPulse 1.5s infinite alternate;
    }
    </style>
</head>
<body>

<div id="start-screen">
        <div class="main-title">VOCAB<br>BATTLESHIP</div>
        <div style="display: flex; gap: 20px;">
            <button class="start-btn-large" onclick="selectMode('AI')">VS A.I.</button>
<button class="start-btn-large btn-pvp" onclick="selectMode('PVP')">
    VS PLAYER
</button>
        </div>
        <div style="margin-top: 20px; color: #94a3b8; font-size: 12px;">SYSTEM READY // SELECT COMBAT MODE</div>
    </div>
<div id="level-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 250; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <h2 style="font-family: 'Black Ops One'; color: var(--primary); font-size: 40px; margin-bottom: 30px; text-shadow: 0 0 20px var(--primary);">SELECT DIFFICULTY</h2>
        
        <div class="level-grid">
            <button class="level-btn" onclick="selectLevel('L1')">LEVEL 1</button>
            <button class="level-btn" onclick="selectLevel('L2')">LEVEL 2</button>
            <button class="level-btn" onclick="selectLevel('L3')">LEVEL 3</button>
            <button class="level-btn" onclick="selectLevel('L4')">LEVEL 4</button>
            <button class="level-btn" onclick="selectLevel('L5')">LEVEL 5</button>
            <button class="level-btn" onclick="selectLevel('L5_STAR')">LEVEL 5*</button>
        </div>

<button class="btn" onclick="playSound('delete-sfx'); closeLevelScreen()" style="margin-top: 30px; border-color: #64748b; color: #94a3b8;">&lt; BACK</button>
    </div>
    <div id="lobby-screen" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 150; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <h2 style="font-family: 'Black Ops One'; color: var(--primary); font-size: 40px;">MULTIPLAYER LOBBY</h2>
        
        <div style="background: rgba(15, 23, 42, 0.9); padding: 30px; border: 1px solid var(--primary); border-radius: 10px; text-align: center;">
            <div style="margin-bottom: 20px; color: #fff;">Your ID: <span id="player-id-display" style="color: var(--warning);">Connecting...</span></div>
            
<button class="btn" onclick="prepareCreateRoom()" style="width: 100%; margin-bottom: 20px; font-size: 18px;">CREATE NEW ROOM</button>
            
            <div style="color: #94a3b8; margin: 10px 0;">-- OR JOIN ROOM --</div>
            
            <input type="text" id="room-id-input" placeholder="ENTER ROOM ID" style="background: #000; border: 1px solid #475569; padding: 10px; color: #fff; text-align: center; width: 200px; margin-bottom: 10px;">
            <br>
            <button class="btn" onclick="joinRoom()" style="width: 100%;">JOIN MISSION</button>
        </div>
        <div id="lobby-msg" style="color: var(--danger); margin-top: 20px; height: 20px;"></div>
    </div>

    <div id="game-ui">
        <div id="control-panel">
            <div id="game-status">PHASE: <span style="color: var(--warning);">DEPLOYMENT</span></div>
            <button id="music-btn" class="btn" onclick="toggleMusic()"> BGM: ON</button>
            <span id="deploy-controls">
                <button id="rotate-btn" class="btn" onclick="rotateShip()">ROTATE: VERTICAL</button>
                <button id="start-btn" class="btn" onclick="startBattle()" disabled>START BATTLE</button>
            </span>
        </div>
<div id="turn-timer-container" style="width: 100%; max-width: 600px; height: 4px; background: #334155; margin-bottom: 10px; display: none;">
        <div id="turn-timer-bar" style="width: 100%; height: 100%; background: var(--warning); transition: width 0.1s linear;"></div>
    </div>
<div id="player-board" class="board-container active">
            <div class="board-label" style="color: var(--success);">MY FLEET</div>
            
            <div class="fleet-main-layout" style="display: flex; align-items: flex-start; justify-content: center; gap: 20px;">
                
                <div id="fleet-sidebar"></div>

                <div id="player-grid" class="game-grid"></div>
                
            </div>
        </div>
<div id="enemy-board" class="board-container">
            <div class="board-label" style="color: var(--danger);">ENEMY SECTOR</div>
            
            <div id="status-panel">
                <div id="enemy-fleet-indicator"></div>
                
                <div class="panel-divider"></div>
                
                <div id="turn-display">
                    <div style="font-size: 10px; color: #94a3b8;">TURN</div>
                    <div id="turn-count">1</div>
                </div>
            </div>

            <div id="enemy-grid" class="game-grid"></div>
        </div>
        <div style="color: rgba(148, 163, 184, 0.8); font-size: 10px; margin-top: auto; margin-bottom: 20px; z-index: 10; text-shadow: 0 0 5px #000;">
            SYSTEM: ONLINE // SECURE CONNECTION
        </div>
    </div>

    <div id="launch-modal" onclick="focusInput()">
        <div class="modal-content">
            <div style="color: var(--danger); font-family: 'Black Ops One'; font-size: 22px;">âš ï¸ DECRYPT CODE âš ï¸</div>
            <div style="font-size: 18px; margin-top: 10px; color: #94a3b8;">Translate to English:</div>
            <div style="font-size: 24px; margin: 10px 0; color: #fff; font-weight: bold;" id="q-text">...</div>
            <div class="vocab-hint" id="q-display">_ _ _ _ _</div>
            <div style="color: #64748b; font-size: 12px;">TYPE TO DECRYPT // ENTER TO FIRE</div>
            
            <div id="timer-bar-container"><div id="timer-bar"></div></div>
            <div id="msg-area" style="height: 20px; color: var(--danger); margin-top: 5px; font-weight: bold;"></div>
            
            <input type="text" id="hidden-input" autocomplete="off">
        </div>
    </div>

    <div id="warning-overlay"></div>
<div id="end-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <h1 id="end-title" style="font-family: 'Black Ops One'; font-size: 80px; margin-bottom: 20px; text-shadow: 0 0 30px currentColor;">VICTORY</h1>
        <div id="end-msg" style="color: #94a3b8; margin-bottom: 40px; font-size: 20px;">ENEMY FLEET ELIMINATED</div>
        <button class="start-btn-large" onclick="resetGame()">RETURN TO BASE</button>
    </div>
<div id="confirm-modal" class="tech-modal-overlay">
        <div class="tech-modal-box">
            <div class="tech-warning-title">âš  WARNING // ABORT?</div>
            <div class="tech-warning-msg">ALL MISSION PROGRESS WILL BE LOST.<br>CONFIRM ABORT SEQUENCE?</div>
            
            <div class="tech-btn-group">
                <button class="tech-btn cancel" onclick="closeConfirmModal()">CANCEL</button>
                <button class="tech-btn confirm" onclick="executeAbort()">CONFIRM ABORT</button>
            </div>
        </div>
    </div>
<button id="global-back-btn" onclick="confirmExit()">
        &lt; BACK TO MENU
    </button>
<div id="tech-notification">
        <div id="notif-title">SYSTEM MESSAGE</div>
        <div id="notif-content">...</div>
        <div class="scan-line"></div>
    </div>


    <audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg"></audio>
    <audio id="deploy-sfx"><source src="deploy.mp3" type="audio/mpeg"></audio>
    <audio id="enter-sfx"><source src="enter_word.mp3" type="audio/mpeg"></audio>
    <audio id="delete-sfx"><source src="delete_word.mp3" type="audio/mpeg"></audio>
    <audio id="wrong-sfx"><source src="wrong_word.mp3" type="audio/mpeg"></audio>
    <audio id="laser-sfx"><source src="laser_attack.mp3" type="audio/mpeg"></audio>
    <audio id="hit-sfx"><source src="target_hit.mp3" type="audio/mpeg"></audio>
    <audio id="timeout-sfx"><source src="time_out.mp3" type="audio/mpeg"></audio>
<audio id="open-room-sfx"><source src="open_room.mp3" type="audio/mpeg"></audio>
<audio id="destroy-sfx"><source src="target_destory.mp3" type="audio/mpeg"></audio>

<script>
    let lastProcessedTimestamp = 0; // â˜… æ–°å¢ï¼šé˜²æ­¢é‡è¤‡è™•ç†åŒä¸€æ‰‹æ£‹
let battleUnsubscribe = null; // â˜… æ–°å¢ï¼šå°ˆé–€ç®¡ç†æˆ°é¬¥ä¸­çš„ç›£è½å™¨
let turnCounter = 0; // å›åˆè¨ˆæ•¸å™¨
    // --- 1. Firebase è¨­å®š (å·²å¡«å…¥ä½ çš„è³‡æ–™) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBdfTgb7FpkYdgjvrYWQ0jr-N-1fAaW9Q0",
        authDomain: "vocabularyxdungeon.firebaseapp.com",
        databaseURL: "https://vocabularyxdungeon-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "vocabularyxdungeon",
        storageBucket: "vocabularyxdungeon.appspot.com",
        messagingSenderId: "834761939928",
        appId: "1:834761939928:web:4591dcd9650ec99746f0ad"
    };

    // --- 2. éŠæˆ²åƒæ•¸ ---
    const GRID_SIZE = 10;

const FLEET = [
        { width: 1, height: 2, img: '1x2.png' },
        { width: 1, height: 3, img: '1x3.png' },
        { width: 1, height: 4, img: '1x4.png' },
        { width: 2, height: 4, img: '2x4.png' },
        // æ–°å¢ï¼š1x3+1 æˆ°è‰¦ (Tå‹)
        { 
            width: 2,    // å‚ç›´æ™‚çš„ç¸½é—Šåº¦
            height: 3,   // å‚ç›´æ™‚çš„ç¸½é«˜åº¦
            img: '1x3+1.png', // è¨˜å¾—å°‡ä½ çš„åœ–ç‰‡æ”¹ååšé€™å€‹
            custom: true, // æ¨™è¨˜ç‚ºç‰¹æ®Šå½¢ç‹€
            // å‚ç›´ä½ˆå±€ (2x3): å·¦é‚Š3æ ¼ç›´æ¢ï¼Œå³é‚Šä¸­é–“çªå‡ºä¸€æ ¼
            // 1=æœ‰èˆ¹, 0=é€æ˜
            layoutV: [
                1, 0,
                1, 1,
                1, 0
            ],
            // æ°´å¹³ä½ˆå±€ (3x2): ä¸Šé¢ä¸­é–“çªå‡ºä¸€æ ¼ï¼Œä¸‹é¢3æ ¼æ©«æ¢
            // æ—‹è½‰90åº¦å¾Œçš„æ¨£å­
            layoutH: [
                0, 1, 0,
                1, 1, 1
            ]
        }
    ];
const DAMAGED_IMAGES = [
        '1x2_damaged.png', 
        '1x3_damaged.png', 
        '1x4_damaged.png', 
        '2x4_damaged.png',
        '1x3+1_damaged.png' // æš«æ™‚ç”¨åŸåœ–é ‚ä½å…ˆï¼Œå¦‚æœä½ æœ‰ 1x3+1_damaged.png å°±æ”¹å‘¢åº¦
    ];
// --- é¡Œç›®è³‡æ–™åº« (åˆ†ç´š) ---
    const VOCAB_DB = {
        'L1': [
            { ch: "è˜‹æœ", en: "APPLE" }, { ch: "è²“", en: "CAT" }, { ch: "ç‹—", en: "DOG" },
            { ch: "ç´…è‰²", en: "RED" }, { ch: "å¤§", en: "BIG" }
        ],
        'L2': [
            { ch: "å­¸æ ¡", en: "SCHOOL" }, { ch: "æœ‹å‹", en: "FRIEND" }, { ch: "å¿«æ¨‚", en: "HAPPY" },
            { ch: "å¤æ—¥", en: "SUMMER" }, { ch: "èŠ±åœ’", en: "GARDEN" }
        ],
        'L3': [
            { ch: "å±éšª", en: "DANGER" }, { ch: "è¡Œæ˜Ÿ", en: "PLANET" }, { ch: "ç³»çµ±", en: "SYSTEM" },
            { ch: "ç«ç®­", en: "ROCKET" }, { ch: "èƒ½é‡", en: "ENERGY" }
        ],
        'L4': [
            { ch: "å®‡å®™", en: "UNIVERSE" }, { ch: "æ˜Ÿç³»", en: "GALAXY" }, { ch: "æ°§æ°£", en: "OXYGEN" },
            { ch: "é‡åŠ›", en: "GRAVITY" }, { ch: "æµæ˜Ÿ", en: "METEOR" }
        ],
        'L5': [
            { ch: "å°è¡Œæ˜Ÿ", en: "ASTEROID" }, { ch: "è¡›æ˜Ÿ", en: "SATELLITE" }, { ch: "é»‘æ´", en: "BLACKHOLE" },
            { ch: "å¤ªç©ºäºº", en: "ASTRONAUT" }, { ch: "ç¶­åº¦", en: "DIMENSION" }
        ],
        'L5_STAR': [
            { ch: "æ˜Ÿéš›ç©¿è¶Š", en: "INTERSTELLAR" }, { ch: "å¥‡é»", en: "SINGULARITY" }, 
            { ch: "å…‰å¹´", en: "LIGHTYEAR" }, { ch: "è¶…æ–°æ˜Ÿ", en: "SUPERNOVA" },
            { ch: "é‡å­åŠ›å­¸", en: "QUANTUM" }
        ]
    };

    // å…¨å±€è®Šæ•¸ï¼šç•¶å‰ä½¿ç”¨çš„ç”Ÿå­—è¡¨
    let activeVocabList = []; 
    let selectedLevel = 'L1'; // é è¨­
    let tempGameMode = 'AI';  // æš«å­˜æ¨¡å¼é¸æ“‡

    // --- 3. å…¨å±€è®Šæ•¸ ---
let deploymentTimerInterval = null; // ä½ˆé™£å€’æ•¸å™¨
let turnTimerInterval = null; // ç”¨ä¾†è¨ˆé¸ä½å—° 8 ç§’
    let app, db, auth;
    let myPlayerId = null, currentRoomId = null, gameMode = 'AI', playerRole = null;
    let myGrid = Array(GRID_SIZE*GRID_SIZE).fill(0);   
    let enemyGrid = Array(GRID_SIZE*GRID_SIZE).fill(0); 
    let enemyShots = []; 
    let currentPhase = 'DEPLOY'; 
    let deployIndex = 0;
    let isVertical = true;
    let currentTargetIndex = null, timerInterval = null, currentVocab = null;
    let isMusicPlaying = false;
let gameTimeouts = [];

// â˜… é€™æ˜¯ä¹‹å‰æ¼å’—å˜…å‡½æ•¸ï¼Œå¿…é ˆè¦æœ‰ä½¢ï¼ŒVS AI å…ˆå””æœƒæ­»æ©Ÿ â˜…
function setGameTimeout(callback, delay) {
    const id = setTimeout(() => {
        callback();
        // åŸ·è¡Œå®Œå¾Œï¼Œå¾åˆ—è¡¨ä¸­ç§»é™¤è‡ªå·± (ä¿æŒé™£åˆ—æ•´æ½”)
        gameTimeouts = gameTimeouts.filter(t => t !== id);
    }, delay);
    gameTimeouts.push(id);
    return id;
}

function startEnemyTurn() {
    currentPhase = 'ENEMY_TURN';
    switchScene('ENEMY');
    document.getElementById('warning-overlay').style.display = 'block';
    
    // æ”¹ç”¨ setGameTimeout
    setGameTimeout(aiFire, 2000);
}

    const TOTAL_HP = 21; 
    let myDamage = 0;    // æˆ‘è¢«æ‰“ä¸­å¹¾å¤šæ ¼ (æˆ‘è¼¸çš„é€²åº¦)
    let enemyDamage = 0; // æ•µäººè¢«æ‰“ä¸­å¹¾å¤šæ ¼ (æˆ‘è´çš„é€²åº¦)
    let unsubscribeRoom = null; // ç”¨ä¾†å„²å­˜ Firebase ç›£è½å™¨

    // --- 4. åˆå§‹åŒ– ---
window.addEventListener('load', () => {
        // --- Firebase Init ---
        const { initializeApp, getDatabase, getAuth, signInAnonymously, onAuthStateChanged } = window.firebaseModules;
        
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);

        signInAnonymously(auth).catch(e => console.error("Login Error:", e));
        
        onAuthStateChanged(auth, u => {
            if (u) {
                myPlayerId = u.uid;
                const disp = document.getElementById('player-id-display');
                if(disp) disp.innerText = u.uid.substring(0,6).toUpperCase();
            }
        });
        
        createGrid('player-grid');
        createGrid('enemy-grid');
        placeEnemyShips(); 
        renderSidebar();
const roomInput = document.getElementById('room-id-input');
        if (roomInput) {
            roomInput.addEventListener('input', (e) => {
                // å¦‚æœä¿‚åˆªé™¤ (Backspace/Delete)
                if (e.inputType === 'deleteContentBackward' || e.inputType === 'deleteContentForward') {
                    playSound('delete-sfx'); 
                } 
                // å¦‚æœä¿‚è¼¸å…¥ (æ‰“å­—)
                else {
                    playSound('enter-sfx'); 
                }
            });
        }
    });

    // --- 5. æµç¨‹æ§åˆ¶ ---
function selectMode(mode) {
        tempGameMode = mode; // å…ˆè¨˜ä½ä½ æƒ³ç©ä¹œ Mode
        playSound('deploy-sfx');
        
        if (mode === 'AI') {
            // AI æ¨¡å¼ï¼šç…§èˆŠï¼Œå…ˆæ€ Level
            document.getElementById('level-screen').style.display = 'flex';
        } else {
            // PVP æ¨¡å¼ï¼šç›´æ¥å…¥ Lobbyï¼Œå””å¥½æ€ Level ä½
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
            document.getElementById('global-back-btn').style.display = 'block';
        }
    }
    
    // æ–°å¢ï¼šé—œé–‰ç­‰ç´šé¸å–®
    function closeLevelScreen() {
        document.getElementById('level-screen').style.display = 'none';
    }

    function prepareCreateRoom() {
        playSound('deploy-sfx');
        // å½ˆå‡º Level é¸å–®ç•€å ´ä¸»æ€
        document.getElementById('level-screen').style.display = 'flex';
    }

    function selectLevel(level) {
        selectedLevel = level;
        activeVocabList = VOCAB_DB[level]; // è¨­å®šé¡Œåº«
        
        playSound('deploy-sfx');
        closeLevelScreen(); // é—œé–‰é¸å–®

        if (tempGameMode === 'AI') {
            gameMode = 'AI';
            document.getElementById('global-back-btn').style.display = 'block';
            enterGameUI();
        } else {
            // PVP æ¨¡å¼ï¼šä¾†åˆ°é€™è£¡ä»£è¡¨ä¿‚ Host å‰›æ€å®Œ Level
            gameMode = 'PVP';
            
            // â˜… ä¿®æ”¹é‡é»ï¼šé¸å®Œ Level å³åˆ»åŸ·è¡Œé–‹æˆ¿ â˜…
            createRoom(); 
        }
    }
function enterGameUI() {
        const bgm = document.getElementById('bgm');
        if (bgm) { bgm.volume = 0.5; bgm.play().then(()=>isMusicPlaying=true).catch(e=>{}); }

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'none';
        
        const gameUI = document.getElementById('game-ui');
        gameUI.style.display = 'flex';
        setTimeout(() => { gameUI.style.opacity = '1'; }, 50);
        
        // â˜… é—œéµï¼šé€²å…¥éŠæˆ²ç•«é¢å…ˆé–‹å§‹ä½ˆé™£å€’æ•¸ â˜…
        startDeploymentTimer();
        
        if (gameMode === 'PVP') initPVPListeners();
    }

    // --- 6. PVP é‚è¼¯ ---
function createRoom() {
        // â˜… æ–°å¢ï¼šä¸€æŒ‰æ£å³åˆ»æ’­æ”¾é–‹æˆ¿éŸ³æ•ˆ â˜…
        playSound('open-room-sfx');

        const { ref, set, onValue } = window.firebaseModules;
        const roomId = Math.floor(1000 + Math.random() * 9000).toString();
        currentRoomId = roomId;
        playerRole = 'host';

set(ref(db, 'rooms/' + roomId), {
            host: myPlayerId, 
            guest: null, 
            status: 'waiting', 
            turn: 'host',
            level: selectedLevel // â˜… æ–°å¢ï¼šå„²å­˜ç­‰ç´šè¨­å®š â˜…
        });
        
        const msg = document.getElementById('lobby-msg');
        msg.innerText = `ROOM: ${roomId} - WAITING...`; 
        msg.style.color = "var(--success)";

        const roomRef = ref(db, 'rooms/' + roomId);
        
unsubscribeRoom = onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.guest) {
                if (unsubscribeRoom) unsubscribeRoom(); 
                showNotification(`PLAYER LINKED! ROOM ${roomId}`);
                
                // â˜… æ–°å¢ï¼šè¨­å®šæ–·ç·šè™•ç† â˜…
                setupDisconnectHandler();

                setTimeout(() => {
                    enterGameUI();
                }, 1500);
            }
        });
    }
function joinRoom() {
        const { ref, get, update } = window.firebaseModules;
        const inputId = document.getElementById('room-id-input').value.trim();
        
        // ç°¡å–®æª¢æŸ¥é•·åº¦
        if (inputId.length !== 4) {
            playSound('wrong-sfx'); 
            return;
        }
        
        const roomRef = ref(db, 'rooms/' + inputId);
        get(roomRef).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                // æª¢æŸ¥æˆ¿é–“æ˜¯å¦æœªæ»¿
                if (!data.guest) {
                    playSound('open-room-sfx');
                    currentRoomId = inputId;
                    playerRole = 'guest';
                    
                    // â˜… é—œéµä¿®å¾©ï¼šå¿…é ˆåœ¨é€™è£¡å¼·åˆ¶è¨­å®šç‚º PVP æ¨¡å¼ï¼ â˜…
                    // å› ç‚º Guest è·³éäº† selectLevelï¼Œå¦‚æœå””åŠ å‘¢å¥ï¼Œç³»çµ±æœƒä»¥ç‚ºä¿‚ç© AI
                    gameMode = 'PVP'; 

                    // Guest è·Ÿéš¨ Host çš„ç­‰ç´šè¨­å®š
                    if (data.level && VOCAB_DB[data.level]) {
                        selectedLevel = data.level;
                        activeVocabList = VOCAB_DB[data.level];
                        showNotification(`SYNCED: ${data.level}`, 'success');
                    }

                    update(roomRef, { guest: myPlayerId, status: 'deploying' });
                    
                    setupDisconnectHandler();

                    if (typeof showNotification === 'function') {
                        showNotification(`LINKING TO ROOM ${inputId}...`);
                    }
                    enterGameUI();
                } else {
                    document.getElementById('lobby-msg').innerText = "ROOM FULL";
                    playSound('wrong-sfx'); 
                }
            } else {
                document.getElementById('lobby-msg').innerText = "ROOM NOT FOUND";
                playSound('wrong-sfx'); 
            }
        });
    }

function initPVPListeners() {
        const { ref, onValue, off } = window.firebaseModules;
        
        // 1. å…ˆç§»é™¤èˆŠçš„ç›£è½ (é˜²æ­¢ç´¯ç©)
        const roomRef = ref(db, 'rooms/' + currentRoomId);
        off(roomRef); 

        // 2. å•Ÿå‹•æ–°ç›£è½
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // --- å‹åˆ©/å¤±æ•— åˆ¤æ–· ---
            if (data.winner) {
                if (currentPhase === 'GAME_OVER') return; // å¦‚æœå·²ç¶“å®Œå’—å°±å””å¥½å†å½ˆ
                
                if (data.winner === playerRole) {
                    document.getElementById('end-title').innerText = "VICTORY";
                    document.getElementById('end-title').style.color = "var(--success)";
                    document.getElementById('end-title').style.textShadow = "0 0 30px var(--success)";
                    
                    const reason = data.endReason === 'disconnected' ? "CONNECTION LOST" : 
                                   data.endReason === 'surrendered' ? "SURRENDERED" : "DESTROYED";
                    document.getElementById('end-msg').innerText = `ENEMY ${reason}`;
                    
                    document.getElementById('end-screen').style.display = "flex";
                    playSound('deploy-sfx'); 
                } else {
                    document.getElementById('end-title').innerText = "DEFEAT";
                    document.getElementById('end-title').style.color = "var(--warning)";
                    document.getElementById('end-title').style.textShadow = "0 0 30px var(--warning)";
                    document.getElementById('end-msg').innerText = "FLEET DESTROYED";
                    
                    document.getElementById('end-screen').style.display = "flex";
                    playSound('wrong-sfx');
                }
                currentPhase = 'GAME_OVER';
                return; 
            }

            // --- æˆ°é¬¥é‚è¼¯ ---
            if (!data.lastMove) return;
            const move = data.lastMove;
            
            // â˜… é—œéµä¿®æ­£ 1ï¼šæª¢æŸ¥ Timestampï¼Œé˜²æ­¢é‡è¤‡è™•ç†åŒä¸€æ‰‹æ£‹ â˜…
            if (move.timestamp <= lastProcessedTimestamp) {
                return; // å·²ç¶“è™•ç†éå‘¢ä¸€æ‰‹ï¼Œå¿½ç•¥ï¼
            }
            
            // å¦‚æœé€™ä¸€æ‰‹å””ä¿‚æˆ‘æ‰“å˜…ï¼Œå³ä¿‚å°æ‰‹æ‰“éåšŸ
            if (move.attacker !== playerRole) {
                
                // æ›´æ–°æ™‚é–“æˆ³è¨˜
                lastProcessedTimestamp = move.timestamp;

                // å°æ‰‹è¶…æ™‚
                if (move.index === -1) {
                    const status = document.getElementById('game-status');
                    status.innerHTML = `OPPONENT TIMED OUT!`;
                    status.style.color = "var(--success)";
                    playSound('time-out-sfx'); // ä¿®æ­£éŸ³æ•ˆå
                    setGameTimeout(startPlayerTurn, 1500);
                    return;
                }

                const idx = move.index;
                const cell = document.getElementById('player-grid').children[idx];
                
                // å¦‚æœè©²æ ¼å·²ç¶“é–‹éï¼Œéƒ½è¦å¿½ç•¥ (é›™é‡ä¿éšª)
                if (cell.classList.contains('revealed')) return;

                // åŸ·è¡Œè¢«æ“Šä¸­å‹•ç•«
                cell.classList.add('revealed');
                playSound('laser-sfx');
                triggerAnimation(cell, 'blue');
                
                // å»¶é²é¡¯ç¤ºçµæœ
                setGameTimeout(() => {
                    if (myGrid[idx] === 1) {
                        cell.classList.add('hit');
                        playSound('hit-sfx');
                        triggerAnimation(cell, 'orange');
                        
                        myDamage++;
                        
                        // æª¢æŸ¥è‡ªå·±æœ‰ç„¡èˆ¹æ²‰å’—
                        checkMyShipDestruction(idx); 

                        if (checkGameOver()) return;
                    } else {
                        cell.classList.add('miss');
                        cell.innerText = "X";
                    }
                }, 500);
                
                // â˜… é—œéµä¿®æ­£ 2ï¼šç¢ºä¿åªå‘¼å«ä¸€æ¬¡ startPlayerTurn â˜…
                setGameTimeout(() => {
                    if (currentPhase !== 'GAME_OVER') {
                        startPlayerTurn();
                    }
                }, 1200);
            }
        });
    }   
    // --- 7. ä½ˆé™£é‚è¼¯ ---
    function createGrid(elementId) {
        const board = document.getElementById(elementId);
        board.innerHTML = '';
        for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            cell.dataset.index = i;
            if (elementId === 'player-grid') {
                cell.addEventListener('mouseover', () => handleHover(i));
                cell.addEventListener('click', () => handleClick(i));
            } else {
                cell.addEventListener('click', () => handleEnemyGridClick(i));
            }
            board.appendChild(cell);
        }
        board.addEventListener('mouseleave', clearPreview);
    }

function getShipIndices(idx, conf, v) {
        let indices = [];
        let r = Math.floor(idx / GRID_SIZE);
        let c = idx % GRID_SIZE;
        
        // å¦‚æœæ˜¯å‚ç›´(v=true)ï¼Œç”¨åŸæœ¬é•·é—Šï¼›æ°´å¹³å‰‡å°èª¿
        let w = v ? conf.width : conf.height;
        let h = v ? conf.height : conf.width;
        
        // 1. æª¢æŸ¥é‚Šç•Œ (å‡ºç•Œå°±å›å‚³ null)
        if (r + h > GRID_SIZE || c + w > GRID_SIZE) return null;
        
        // 2. è¨ˆç®—æ ¼ä»”ä½ç½®
        if (conf.custom) {
            // â˜… ç‰¹æ®Šå½¢ç‹€é‚è¼¯ â˜…
            const layout = v ? conf.layoutV : conf.layoutH;
            
            for (let i = 0; i < h; i++) {
                for (let j = 0; j < w; j++) {
                    // æª¢æŸ¥ layout é™£åˆ—ï¼šå¦‚æœæ˜¯ 1 æ‰ç®—æœ‰èˆ¹
                    const layoutIdx = i * w + j;
                    if (layout[layoutIdx] === 1) {
                        indices.push((r + i) * GRID_SIZE + (c + j));
                    }
                }
            }
        } else {
            // â˜… æ™®é€šé•·æ–¹å½¢é‚è¼¯ (èˆŠä»£ç¢¼) â˜…
            for (let i = 0; i < h; i++) {
                for (let j = 0; j < w; j++) {
                    indices.push((r + i) * GRID_SIZE + (c + j));
                }
            }
        }
        
        return indices;
    }

    function handleHover(index) {
        if (currentPhase !== 'DEPLOY') return;
        clearPreview();
        if (deployIndex >= FLEET.length) return;
        
        const indices = getShipIndices(index, FLEET[deployIndex], isVertical);
        const cells = document.getElementById('player-grid').children;
        
        if (!indices) { 
            cells[index].classList.add('invalid-hover'); 
            return; 
        }
        
        let overlap = indices.some(idx => myGrid[idx] === 1);
        indices.forEach(idx => cells[idx].classList.add(overlap ? 'invalid-hover' : 'valid-hover'));
    }

    function clearPreview() { 
        document.querySelectorAll('.cell').forEach(c => c.classList.remove('valid-hover', 'invalid-hover')); 
    }

// â˜… ä¿®æ­£ç‰ˆï¼šhandleClick (åŠ å…¥ isVertical è¨˜éŒ„) â˜…
    function handleClick(index) {
        if (currentPhase === 'DEPLOY') {
            // å¦‚æœé»æ“Šçš„æ˜¯å´é‚Šæ¬„ (éƒ¨ç½²æ–°èˆ¹)
            if (index >= 100) return; 

            // è™•ç†æ”¾ç½®é‚è¼¯
            if (deployIndex < FLEET.length) {
                // æª¢æŸ¥æ˜¯å¦é»æ“Šäº†æœ‰æ•ˆæ ¼å­
                const conf = FLEET[deployIndex];
                const r = Math.floor(index / 10);
                const c = index % 10;
                
                // é€™è£¡æœƒæª¢æŸ¥èƒ½ä¸èƒ½æ”¾
                const indices = getShipIndices(r, c, conf.width, conf.height, isVertical);
                
                // å¦‚æœä½ç½®åˆæ³• (isValid)
                if (indices.every(idx => idx >= 0 && idx < 100 && myGrid[idx] === 0)) {
                    
                    playSound('deploy-sfx');

                    // 1. æ¨™è¨˜æ ¼å­
                    indices.forEach(idx => myGrid[idx] = 1);
                    
                    // 2. å„²å­˜èˆ¹çš„æ•¸æ“š
                    FLEET[deployIndex].indices = indices;
                    
                    // â˜… é—œéµä¿®æ”¹ï¼šåœ¨é€™è£¡è¨˜ä½å®ƒæ˜¯ç›´é‚„æ˜¯æ©«ï¼ â˜…
                    FLEET[deployIndex].isVertical = isVertical; 

                    // 3. æ”¾ç½®åœ–ç‰‡
                    placeShipImage('player-grid', index, conf, isVertical);
                    
                    // 4. æ›´æ–° UI
                    const sidebarItem = document.getElementById(`ship-unit-${deployIndex}`);
                    if(sidebarItem) {
                        sidebarItem.classList.remove('current');
                        sidebarItem.classList.add('deployed');
                        sidebarItem.style.opacity = "0.5";
                    }

                    deployIndex++;
                    
                    // 5. æº–å‚™ä¸‹ä¸€éš»èˆ¹
                    if (deployIndex < FLEET.length) {
                        const nextItem = document.getElementById(`ship-unit-${deployIndex}`);
                        if(nextItem) nextItem.classList.add('current');
                        
                        // é‡ç½®æ—‹è½‰ç‹€æ…‹ (é è¨­è®Šå›æ©«)
                        isVertical = false; 
                        updateGhost(); 
                    } else {
                        // å…¨éƒ¨æ”¾å®Œ
                        document.getElementById('deploy-controls').style.display = 'none';
                        document.getElementById('start-btn').disabled = false;
                        document.getElementById('game-status').innerHTML = "FLEET READY. <span style='color:#4ade80'>AWAITING ORDERS</span>";
                        playSound('enter-sfx');
                        
                        // æ¸…é™¤ Ghost
                        document.querySelectorAll('.ghost-cell').forEach(el => el.remove());
                    }
                } else {
                    playSound('wrong-sfx'); // æ”¾ä¸åˆ°
                }
            }
        } else if (currentPhase === 'PLAYER_TURN') {
            // æ”»æ“Šéšæ®µ (VS AI / PVP)
            if (gameMode === 'PVP') {
                handlePVPClick(index);
            } else {
                handleAIClick(index);
            }
        }
    }

    function placeShipImage(boardId, idx, conf, v) {
        const board = document.getElementById(boardId);
        const startCell = board.children[idx];
        const img = document.createElement('img');
        img.src = conf.img;
        img.classList.add('ship-overlay');
        
        if (boardId === 'player-grid') {
            img.id = `board-ship-${deployIndex}`;
        }
        
        const pW = 35 * conf.width + 2 * (conf.width - 1);
        const pH = 35 * conf.height + 2 * (conf.height - 1);
        
        img.style.width = pW + 'px'; 
        img.style.height = pH + 'px';
        img.style.left = startCell.offsetLeft + 'px';
        img.style.top = startCell.offsetTop + 'px';
        
        if (!v) { 
            img.style.transformOrigin = '0 0'; 
            img.style.transform = `rotate(-90deg) translateX(-${pW}px)`; 
        }
        board.appendChild(img);
    }

    function rotateShip() {
        isVertical = !isVertical;
        document.getElementById('rotate-btn').innerText = isVertical ? "ROTATE: VERTICAL" : "ROTATE: HORIZONTAL";
    }

    // --- 8. æˆ°é¬¥æµç¨‹ ---
function startBattle() {
        if (deploymentTimerInterval) clearInterval(deploymentTimerInterval);
        document.getElementById('turn-timer-container').style.display = 'none';
        document.getElementById('deploy-controls').style.display = 'none';
        document.getElementById('fleet-sidebar').style.display = 'none'; 
initEnemyFleetIndicator();
        playSound('deploy-sfx');

        if (gameMode === 'AI') {
            startPlayerTurn();
        } else {
            const { ref, update, onValue } = window.firebaseModules;
            const updates = {};
            const field = (playerRole === 'host') ? 'hostBoard' : 'guestBoard';
            updates[field] = myGrid;
            
            // â˜… æ–°å¢ï¼šç™¼é€æˆ‘çš„è‰¦éšŠä½ç½®çµ¦å°æ‰‹ (å‚³é€ shipId) â˜…
            const myShipsForSending = FLEET.map((s, index) => ({
                shipId: index, // é‡è¦ï¼šå‘Šè¨´å°æ‰‹é€™æ˜¯ç¬¬å¹¾è™Ÿèˆ¹
                indices: s.indices,
                width: s.width,
                height: s.height
                isVertical: s.isVertical
            }));
            updates[field + 'Ships'] = myShipsForSending;
            
            updates[playerRole + 'Ready'] = true;
            
            update(ref(db, 'rooms/' + currentRoomId), updates);
            document.getElementById('game-status').innerHTML = "WAITING FOR OPPONENT...";

battleUnsubscribe = onValue(ref(db, 'rooms/' + currentRoomId), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    
    // ç•¶é›™æ–¹éƒ½æº–å‚™å¥½
    if (data.hostReady && data.guestReady) {
        if (battleUnsubscribe) {
            battleUnsubscribe(); // â˜… é—œéµï¼šä¸€æ—¦é€²å…¥æˆ°é¬¥ï¼Œåœæ­¢ç›£è½æº–å‚™ç‹€æ…‹ï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼
            battleUnsubscribe = null;
        }
        
        if (playerRole === 'host') {
            enemyGrid = data.guestBoard;
            processEnemyFleetData(data.guestBoardShips);
            startPlayerTurn();
        } else {
            enemyGrid = data.hostBoard;
            processEnemyFleetData(data.hostBoardShips);
            currentPhase = 'ENEMY_TURN';
            document.getElementById('game-status').innerHTML = "OPPONENT'S TURN";
            switchScene('ENEMY');
        }
    }
});
        }
    }    function switchScene(sceneName) {
        document.getElementById('player-board').classList.remove('active');
        document.getElementById('enemy-board').classList.remove('active');
        
        if (sceneName === 'PLAYER') {
            document.getElementById('enemy-board').classList.add('active');
            document.getElementById('game-status').innerHTML = `PHASE: <span style="color:var(--success)">YOUR TURN</span>`;
            document.getElementById('control-panel').style.borderColor = "var(--success)";
        } else {
            document.getElementById('player-board').classList.add('active');
            document.getElementById('game-status').innerHTML = `PHASE: <span style="color:var(--danger)">WARNING! ENEMY</span>`;
            document.getElementById('control-panel').style.borderColor = "var(--danger)";
        }
    }

    function handleEnemyGridClick(index) {
        if (currentPhase === 'PLAYER_TURN') {
            const cell = document.getElementById('enemy-grid').children[index];
            if (!cell.classList.contains('revealed')) {
                openLaunchModal(index);
            }
        }
    }

function openLaunchModal(index) {
        // --- 1. åœæ­¢é¸ä½å€’æ•¸ ---
        if (turnTimerInterval) clearInterval(turnTimerInterval);
        document.getElementById('turn-timer-container').style.display = 'none';
        document.getElementById('game-status').innerHTML = `PHASE: <span style="color:var(--warning)">DECRYPTING...</span>`;

        currentTargetIndex = index;
        const modal = document.getElementById('launch-modal');
        const input = document.getElementById('hidden-input');
        const timerBar = document.getElementById('timer-bar');
        
// --- 2. æº–å‚™é¡Œç›® ---
        // â˜… ä¿®æ”¹ï¼šå¾ activeVocabList æŠ½é¡Œç›®ï¼Œè€Œå””ä¿‚ vocabList â˜…
        currentVocab = activeVocabList[Math.floor(Math.random() * activeVocabList.length)];
        document.getElementById('q-text').innerText = currentVocab.ch;
        document.getElementById('msg-area').innerText = "";
        input.value = "";
        updateDisplay(""); 
        
        modal.style.display = "flex";
        input.focus();

        // --- 3. â˜… éšæ®µä¸€ï¼šå……èƒ½å‹•ç•« (Fill Up) â˜… ---
        // å…ˆé‡ç½®ç‚º 0ï¼Œç„¡å‹•ç•«
        timerBar.style.transition = 'none';
        timerBar.style.width = '0%';
        timerBar.offsetHeight; // å¼·åˆ¶ç€è¦½å™¨æ¸²æŸ“

        // è¨­å®š 0.5ç§’ çš„å……èƒ½å‹•ç•«ï¼Œç„¶å¾ŒåŠ æ»¿åˆ° 100%
        timerBar.style.transition = 'width 0.5s ease-out';
        timerBar.style.width = '100%';

        // --- 4. è¨ˆç®—å‹•æ…‹æ™‚é–“ ---
        const totalTime = 3 + (currentVocab.en.length * 0.7);
        let timeLeft = totalTime;
        
        if(timerInterval) clearInterval(timerInterval);
        
        // --- 5. â˜… éšæ®µäºŒï¼šç­‰å¾…å……èƒ½å®Œç•¢ï¼Œç„¶å¾Œé–‹å§‹å€’æ•¸ â˜… ---
        // å»¶é² 0.5ç§’ (ç­‰ä¸Šé¢å€‹å‹•ç•«æ’­å®Œ)
        setTimeout(() => {
            // åˆ‡æ›ç‚ºç·šæ€§å‹•ç•« (Linear)ï¼Œä»¤å€’æ•¸éç¨‹é †æ»‘
            timerBar.style.transition = 'width 0.1s linear';
            
            // é–‹å§‹å€’æ•¸è¿´åœˆ
            timerInterval = setInterval(() => {
                timeLeft -= 0.1; 
                
                // è¨ˆç®—ç™¾åˆ†æ¯” (æ ¹æ“šç¸½æ™‚é–“é•·çŸ­ï¼Œæ‰£æ¸›é€Ÿåº¦æœƒè‡ªå‹•ä¸åŒ)
                const percentage = (timeLeft / totalTime) * 100;
                timerBar.style.width = percentage + "%";
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handlePlayerTimeout();
                }
            }, 100); 
        }, 500); // é€™è£¡çš„ 500ms å°æ‡‰ä¸Šé¢çš„ transition 0.5s
    }

function handlePlayerTimeout() {
        document.getElementById('launch-modal').style.display = "none";
        playSound('timeout-sfx');
        
        const status = document.getElementById('game-status');
        status.innerHTML = `PHASE: <span style="color:var(--danger)">TIMEOUT - TURN LOST</span>`;
        document.getElementById('control-panel').style.borderColor = "var(--danger)";
        
        // â˜… æ”¹ç”¨ setGameTimeout â˜…
        setGameTimeout(() => {
            if (gameMode === 'AI') startEnemyTurn();
            else {
                currentPhase = 'ENEMY_TURN';
                document.getElementById('game-status').innerHTML = "OPPONENT'S TURN";
            }
        }, 1500);
    }

    function focusInput() { document.getElementById('hidden-input').focus(); }

    document.getElementById('hidden-input').addEventListener('input', (e) => {
        let val = e.target.value.toUpperCase();
        if (val.length > currentVocab.en.length) { 
            val = val.substring(0, currentVocab.en.length); 
            e.target.value = val; 
        }
        if (e.inputType === 'deleteContentBackward') playSound('delete-sfx'); 
        else playSound('enter-sfx');
        updateDisplay(val);
    });

    document.getElementById('hidden-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkAnswer();
    });

    function updateDisplay(val) {
        let h = "";
        for (let i=0; i<currentVocab.en.length; i++) h += (i<val.length ? val[i] : "_") + " ";
        document.getElementById('q-display').innerText = h.trim();
    }

    function checkAnswer() {
        const val = document.getElementById('hidden-input').value.toUpperCase().trim();
        if (val === currentVocab.en) {
            playerFire(true);
        } else {
            playSound('wrong-sfx');
            document.getElementById('msg-area').innerText = "CODE INVALID!";
            const d = document.getElementById('q-display');
            d.style.color = "var(--danger)";
            setTimeout(() => d.style.color = "var(--primary)", 500);
        }
    }

    // --- 10. æ”»æ“ŠåŸ·è¡Œ ---
function playerFire(success) {
        clearInterval(timerInterval);
        document.getElementById('launch-modal').style.display = "none";
        
        if (success) {
            // PVP æ¨¡å¼
            if (gameMode === 'PVP') {
                const { ref, update } = window.firebaseModules;
                update(ref(db, 'rooms/' + currentRoomId), {
                    lastMove: { attacker: playerRole, index: currentTargetIndex, timestamp: Date.now() }
                });

                const cell = document.getElementById('enemy-grid').children[currentTargetIndex];
                cell.classList.add('revealed');
                playSound('laser-sfx');
                triggerAnimation(cell, 'blue');
                
                // å‹•ç•«å»¶é² (0.5ç§’)
                setGameTimeout(() => {
                    if (enemyGrid[currentTargetIndex] === 1) {
                        cell.classList.add('hit');
                        triggerAnimation(cell, 'orange');
                        
                        enemyDamage++;
                        
                        // æª¢æŸ¥æ“Šæ²‰
                        const isSunk = checkEnemyShipDestruction(currentTargetIndex);
                        if (!isSunk) playSound('hit-sfx');

                        if (checkGameOver()) return; 
                    } else {
                        cell.classList.add('miss');
                        cell.innerText = "X";
                    }

                    // â˜… é—œéµä¿®æ­£ï¼šå°‡é€™è£¡çš„å»¶é²ç”± 1500 æ”¹ç‚º 3000 (3ç§’) â˜…
                    // è®“ä½ æ…¢æ…¢æ¬£è³å®Œæˆ°æœï¼Œå…ˆè‡³è½‰å ´
                    setGameTimeout(() => {
                        currentPhase = 'ENEMY_TURN';
                        document.getElementById('game-status').innerHTML = "OPPONENT'S TURN";
                        switchScene('ENEMY'); 
                    }, 3000); 

                }, 500);

            } 
            // å–®æ©Ÿ AI æ¨¡å¼ (ä¿æŒä¸è®Š)
            else {
                playSound('laser-sfx');
                const cell = document.getElementById('enemy-grid').children[currentTargetIndex];
                cell.classList.add('revealed');
                triggerAnimation(cell, 'blue');
                
                setGameTimeout(() => {
                    let isGameOver = false; 

                    if (enemyGrid[currentTargetIndex] === 1) {
                        cell.classList.add('hit');
                        triggerAnimation(cell, 'orange');
                        enemyDamage++;
                        const isSunk = checkEnemyShipDestruction(currentTargetIndex);
                        if (!isSunk) playSound('hit-sfx');
                        if (checkGameOver()) isGameOver = true;
                    } else {
                        cell.classList.add('miss');
                        cell.innerText = "X";
                    }

                    if (!isGameOver) {
                        // AI æ¨¡å¼é€šå¸¸ç¯€å¥å¿«å•²ï¼Œé€™è£¡ç¶­æŒ 0.7ç§’ (ä½ å¯ä»¥éš¨æ„åŠ é•·ï¼Œä¾‹å¦‚ 1500)
                        setGameTimeout(startEnemyTurn, 700);
                    }
                }, 500);
            }
        }
    }

function aiFire() {
        playSound('laser-sfx');
        let t;
        do { t = Math.floor(Math.random() * 100); } while (enemyShots.includes(t));
        enemyShots.push(t);
        
        const cell = document.getElementById('player-grid').children[t];
        cell.classList.add('revealed');
        triggerAnimation(cell, 'blue');
        
        // å°‡æ‰€æœ‰å¾ŒçºŒå‹•ä½œæ”¾å…¥åŒä¸€å€‹ Timeoutï¼Œç¢ºä¿æœ‰å…ˆå¾Œæ¬¡åº
        setGameTimeout(() => {
            let isGameOver = false; // æ¨™è¨˜éŠæˆ²æ˜¯å¦çµæŸ

            if (myGrid[t] === 1) {
                cell.classList.add('hit');
                playSound('hit-sfx');
                triggerAnimation(cell, 'orange');
                
                myDamage++;
                if (checkGameOver()) {
                    isGameOver = true; // æ¨™è¨˜ç‚ºçµæŸ (ä½ è¼¸äº†)
                }
            } else {
                cell.classList.add('miss');
                cell.innerText = "X";
            }

            // éš±è—ç´…è‰²è­¦å ± (ç„¡è«–æœ‰ç„¡ä¸­éƒ½è¦éš±è—)
            document.getElementById('warning-overlay').style.display = 'none';

            // â˜… é—œéµä¿®å¾©ï¼šåªæœ‰ç•¶ã€Œä½ æœªæ­»ã€æ™‚ï¼Œæ‰è¼ªåˆ°ä½ è¡Œå‹• â˜…
            if (!isGameOver) {
                // å»¶é² 0.7ç§’ (åŠ ä¸ŠåŸæœ¬çš„ 0.5ç§’ = 1.2ç§’)
                setGameTimeout(startPlayerTurn, 700);
            }
        }, 500);
    }

function startPlayerTurn() {
        // â˜… æ–°å¢ï¼šå›åˆæ•¸ +1 â˜…
        turnCounter++;
        document.getElementById('turn-count').innerText = turnCounter;
        
        // åˆ‡æ›å ´æ™¯
        currentPhase = 'PLAYER_TURN';
        switchScene('PLAYER');

        // --- 8ç§’é¸ä½å€’æ•¸ ---
        const barContainer = document.getElementById('turn-timer-container');
        const bar = document.getElementById('turn-timer-bar');
        const status = document.getElementById('game-status');
        
        barContainer.style.display = 'block';
        bar.style.width = '100%';
        
        let timeLeft = 8.0; 
        
        if (turnTimerInterval) clearInterval(turnTimerInterval);
        
        turnTimerInterval = setInterval(() => {
            timeLeft -= 0.1;
            const percentage = (timeLeft / 8.0) * 100;
            bar.style.width = percentage + "%";
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­— (é€™è£¡ä¹Ÿå¯ä»¥é¡¯ç¤ºå›åˆ)
            status.innerHTML = `TURN ${turnCounter} // YOUR MOVE (<span style="color:var(--warning)">${Math.ceil(timeLeft)}s</span>)`;

            if (timeLeft <= 0) {
                clearInterval(turnTimerInterval);
                handleTurnTimeout(); 
            }
        }, 100);
    }

    // --- Helper Functions ---
// â˜… æ–°å¢ï¼šæª¢æŸ¥æˆ‘è‡ªå·±é‚Šéš»èˆ¹æ²‰å’— (å—å®³è€…è¦–è§’) â˜…
    function checkMyShipDestruction(hitIdx) {
        // 1. æµå‡ºè¢«æ‰“ä¸­å—°æ ¼å±¬æ–¼é‚Šéš»èˆ¹
        let targetShip = null;
        let targetIndex = -1;
        
        FLEET.forEach((ship, index) => {
            if (ship.indices && ship.indices.includes(hitIdx)) {
                targetShip = ship;
                targetIndex = index;
            }
        });
        
        if (!targetShip || targetShip.revealed) return; // æµå””åˆ°æˆ–è€…å·²ç¶“çˆ†å’—

        // 2. æª¢æŸ¥å—°éš»èˆ¹ä¿‚å’ªæ¯ä¸€æ ¼éƒ½ä¿¾äººæ‰“ä¸­å’—
        const allHit = targetShip.indices.every(idx => {
            // æª¢æŸ¥è‡ªå·±å€‹æ£‹ç›¤ (player-grid) å˜…æ ¼ä»”æœ‰ç„¡ 'hit' class
            const cell = document.getElementById('player-grid').children[idx];
            return cell.classList.contains('hit');
        });

        if (allHit) {
            revealMyShip(targetShip, targetIndex);
        }
    }

    function revealMyShip(ship, index) {
        ship.revealed = true;
        const grid = document.getElementById('player-grid');
        const container = document.getElementById('player-board');
        const startCell = grid.children[ship.indices[0]];

        // 1. è™•ç†éš±è—ä¸­çš„å®¹å™¨ (ç¢ºä¿èƒ½è®€å–å°ºå¯¸)
        const isVisible = (container.offsetParent !== null);
        let prevDisplay = '';
        let prevVisibility = '';

        if (!isVisible) {
            prevDisplay = container.style.display;
            prevVisibility = container.style.visibility;
            container.style.visibility = 'hidden'; 
            container.style.display = 'block';     
        }

        // 2. è®€å–åº§æ¨™
        const cellLeft = startCell.offsetLeft;
        const cellTop = startCell.offsetTop;
        const cellSize = startCell.offsetWidth;

        // 3. é‚„åŸå®¹å™¨ç‹€æ…‹
        if (!isVisible) {
            container.style.display = prevDisplay;
            container.style.visibility = prevVisibility;
        }

        // 4. éš±è—åŸæœ¬å®Œå¥½çš„èˆ¹åœ–
        const originalShipImg = document.getElementById(`board-ship-${index}`);
        if (originalShipImg) {
            originalShipImg.style.display = 'none'; 
        }

        // 5. å»ºç«‹æˆ°æåœ–ç‰‡
        const img = document.createElement('img');
        if (typeof DAMAGED_IMAGES !== 'undefined' && DAMAGED_IMAGES[index]) {
            img.src = DAMAGED_IMAGES[index];
        } else {
            img.src = ship.img; 
        }
        
        img.classList.add('enemy-ship-revealed'); 
        img.style.zIndex = "10"; 

        const pW = cellSize * ship.width + 2 * (ship.width - 1);
        const pH = cellSize * ship.height + 2 * (ship.height - 1);
        
        img.style.width = pW + 'px';
        img.style.height = pH + 'px';
        img.style.left = cellLeft + 'px';
        img.style.top = cellTop + 'px';
        
        // â˜… é—œéµï¼šå„ªå…ˆä½¿ç”¨å„²å­˜çš„ isVertical â˜…
        let isVertical = ship.isVertical;
        
        // å¦‚æœæ˜¯èˆŠå­˜æª”æ²’æœ‰é€™å€‹è®Šæ•¸ï¼Œæ‰ä½¿ç”¨èˆŠçš„ä¼°ç®—æ–¹æ³•
        if (typeof isVertical === 'undefined') {
             if (ship.indices.length > 1) {
                isVertical = (ship.indices[1] === ship.indices[0] + 10);
             } else {
                isVertical = false;
             }
        }
        
        // æ—‹è½‰èˆ‡ä½ç§»ä¿®æ­£
        if (!isVertical) {
            const shift = (pH - pW) / 2;
            img.style.transform = `translate(${shift}px, -${shift}px) rotate(-90deg)`;
        } else {
            img.style.transform = 'none';
        }
        
        grid.appendChild(img);
        playSound('destroy-sfx'); 
    }

    function initEnemyFleetIndicator() {
        const container = document.getElementById('enemy-fleet-indicator');
        container.innerHTML = ''; 

        FLEET.forEach((ship, index) => {
            const shipBlock = document.createElement('div');
            shipBlock.id = `indicator-ship-${index}`; 
            shipBlock.classList.add('enemy-ship-block');
            
            // â˜… é—œéµ 1ï¼šè¨­å®šç¶²æ ¼é—Šåº¦ â˜…
            // æ ¹æ“šèˆ¹çš„ width è¨­å®šæœ‰å¹¾å¤šç›´è¡Œ (columns)
            shipBlock.style.gridTemplateColumns = `repeat(${ship.width}, 1fr)`;

            // â˜… é—œéµ 2ï¼šæ±ºå®šæ ¼ä»”ä½ˆå±€ â˜…
            // å„ªå…ˆä½¿ç”¨å‚ç›´ä½ˆå±€ layoutV (å¦‚æœ‰)ï¼Œå¦å‰‡å°±å…¨å¡«æ»¿
            let layout = [];
            
            if (ship.custom && ship.layoutV) {
                // å¦‚æœä¿‚ç‰¹æ®Šèˆ¹ (ä¾‹å¦‚ Tå‹)ï¼Œç”¨å®ƒçš„ layoutV
                layout = ship.layoutV;
            } else {
                // å¦‚æœä¿‚æ™®é€šèˆ¹ï¼Œç”Ÿæˆä¸€å€‹å…¨ä¿‚ 1 çš„é™£åˆ— (é•·åº¦ = width * height)
                layout = Array(ship.width * ship.height).fill(1);
            }

            // â˜… é—œéµ 3ï¼šç”Ÿæˆæ ¼ä»” â˜…
            layout.forEach(status => {
                const cell = document.createElement('div');
                cell.classList.add('indicator-cell');
                
                // å¦‚æœ layout ä¿‚ 0ï¼Œä»£è¡¨å—°æ ¼ä¿‚ç©ºæ°£ (ä¾‹å¦‚ Tå‹èˆ¹çš„ç¼ºå£)
                if (status === 0) {
                    cell.classList.add('cell-empty');
                }
                
                shipBlock.appendChild(cell);
            });
            
            container.appendChild(shipBlock);
        });
    }

// â˜… æ–°ç‰ˆï¼šæ›´æ–°ç‹€æ…‹ (è®Šç©ºå¿ƒ) â˜…
// â˜… æ›´æ–°ç‹€æ…‹ (è®Šç©ºå¿ƒï¼Œå¿½ç•¥é€æ˜æ ¼) â˜…
    function updateEnemyIndicator(shipId) {
        const shipBlock = document.getElementById(`indicator-ship-${shipId}`);
        if (shipBlock) {
            // åªé¸å–ã€Œéé€æ˜ã€çš„æ ¼ä»”ä¾†è®Šç©ºå¿ƒ
            const cells = shipBlock.querySelectorAll('.indicator-cell:not(.cell-empty)');
            cells.forEach(cell => {
                cell.classList.add('cell-destroyed');
            });
        }
    }

    let enemyFleetData = [];

    function placeEnemyShips() {
        enemyFleetData = []; // æ¸…ç©ºèˆŠæ•¸æ“š
        let p = 0;
        while (p < FLEET.length) {
            let r = Math.floor(Math.random() * 100);
            let v = Math.random() > 0.5;
            let idxs = getShipIndices(r, FLEET[p], v);
            if (idxs && !idxs.some(x => enemyGrid[x] === 1)) {
                idxs.forEach(x => enemyGrid[x] = 1);
                
                // â˜… å„²å­˜æ•µäººèˆ¹éš»è³‡æ–™ (åŠ å…¥ shipId ä»¥ä¾¿é…å°åœ–ç‰‡) â˜…
                enemyFleetData.push({
                    shipId: p, // è¨˜ä½é€™æ˜¯ç¬¬å¹¾è™Ÿèˆ¹ (0-3)
                    indices: idxs,
                    conf: FLEET[p],
                    rootIndex: r,
                    isVertical: v,
                    revealed: false
                });
                p++;
            }
        }
    }

    function triggerAnimation(cell, type) {
        const d = document.createElement('div');
        if (type === 'blue') d.classList.add('anim-blue');
        if (type === 'orange') d.classList.add('anim-orange');
        cell.appendChild(d);
        setTimeout(() => d.remove(), 500);
    }

    function playSound(id) {
        const s = document.getElementById(id);
        if(s) { s.currentTime = 0; s.play().catch(e=>{}); }
    }

    function toggleMusic() {
        const bgm = document.getElementById('bgm');
        const btn = document.getElementById('music-btn');
        if (isMusicPlaying) {
            bgm.pause(); btn.innerText = " BGM: OFF"; btn.style.background = "";
        } else {
            bgm.play().then(() => { btn.innerText = " BGM: ON"; btn.style.background = "var(--success)"; });
        }
        isMusicPlaying = !isMusicPlaying;
    }

function renderSidebar() {
    const sidebar = document.getElementById('fleet-sidebar');
    if (!sidebar) return; // å®‰å…¨æª¢æŸ¥
    sidebar.innerHTML = ''; 

    FLEET.forEach((ship, index) => {
        const container = document.createElement('div');
        container.id = `ship-unit-${index}`;
        container.classList.add('fleet-unit');
        
        container.style.gridTemplateColumns = `repeat(${ship.width}, 1fr)`;
        
        const totalCells = ship.width * ship.height;
        for(let i=0; i<totalCells; i++) {
            const cell = document.createElement('div');
            cell.classList.add('mini-cell');
            if (ship.custom && ship.layoutV[i] === 0) {
                cell.style.visibility = 'hidden';
            }
            container.appendChild(cell);
        }

        const img = document.createElement('img');
        img.src = ship.img;
        img.classList.add('fleet-ship-img');
        container.appendChild(img);
        
        // è¨­å®šåˆå§‹ç‹€æ…‹
        if (index === 0) container.classList.add('current');
        else container.classList.add('pending');
        
        sidebar.appendChild(container);
    });
}

    function findNextUnplaced() {
        for (let i = 0; i < FLEET.length; i++) {
            if (!FLEET[i].indices) {
                return i;
            }
        }
        return FLEET.length; 
    }

    function checkGameOver() {
        const title = document.getElementById('end-title');
        const msg = document.getElementById('end-msg');
        const screen = document.getElementById('end-screen');
        
        if (enemyDamage >= TOTAL_HP) {
            title.innerText = "VICTORY";
            title.style.color = "var(--success)";
            title.style.textShadow = "0 0 30px var(--success)";
            msg.innerText = "ENEMY FLEET ELIMINATED";
            playSound('hit-sfx'); 
            screen.style.display = "flex";
            return true;
        }
        
        if (myDamage >= TOTAL_HP) {
            title.innerText = "DEFEAT";
            title.style.color = "var(--danger)";
            title.style.textShadow = "0 0 30px var(--danger)";
            msg.innerText = "CRITICAL MISSION FAILURE";
            playSound('timeout-sfx'); 
            screen.style.display = "flex";
            return true;
        }
        
        return false;
    }

function confirmExit() {
        const lobbyScreen = document.getElementById('lobby-screen');
        
        // åˆ¤æ–·ï¼šå¦‚æœ Lobby æ­£åœ¨é¡¯ç¤º (display ä¸ä¿‚ none)ï¼Œä»£è¡¨ä½ ä¿‚å¤§å»³
        if (lobbyScreen.style.display && lobbyScreen.style.display !== 'none') {
            // ç›´æ¥é›¢é–‹ï¼Œç„¡éœ€è­¦å‘Š
            playSound('delete-sfx'); // æ’­å€‹è¼•é¬†å•²å˜…å–æ¶ˆè²
            resetGame(); 
        } else {
            // å¦‚æœä¿‚éŠæˆ²ä¸­ï¼Œå…ˆå½ˆå‡ºè­¦å‘Šè¦–çª—
            document.getElementById('confirm-modal').style.display = 'flex';
            playSound('wrong-sfx'); // æ’­è­¦å ±è²
        }
    }
// â˜… è£œå›é€™å€‹å‡½æ•¸ï¼Œå¦å‰‡å…©å€‹æ£éƒ½æœƒæ­»ç« â˜…
// â˜… ä¿®æ­£ç‰ˆï¼šé—œé–‰ç¢ºèªçª— (æ’­æ”¾å–æ¶ˆè²) â˜…
    function closeConfirmModal() {
        playSound('delete-sfx'); // æ’­ Delete è²
        document.getElementById('confirm-modal').style.display = 'none';
    }

    // 3. æŒ‰ä¸‹ "Confirm Abort" (åŸ·è¡Œé‡ç½®)
    function executeAbort() {
        closeConfirmModal(); // ä¹‹å‰å› ç‚ºæµå””åˆ°ä¸Šé¢å€‹å‡½æ•¸ï¼Œæ‰€ä»¥é€™è£¡å¡ä½äº†
        
        // ... (åŸæœ¬çš„ executeAbort å…§å®¹ä¸ç”¨æ”¹) ...
        if (gameMode === 'PVP' && currentRoomId) {
             // ...
        }
        resetGame(); 
    }
    // 3. æŒ‰ä¸‹ "Confirm Abort" (åŸ·è¡Œé‡ç½®)
// â˜… ä¿®æ­£ç‰ˆï¼šåŸ·è¡Œæ”¾æ£„ä»»å‹™ (æ’­æ”¾éƒ¨ç½²è²) â˜…
    function executeAbort() {
        // 1. æ’­æ”¾ç¢ºèªéŸ³æ•ˆ
        playSound('deploy-sfx'); 

        // 2. æ‰‹å‹•é—œé–‰è¦–çª— (å””å¥½ Call closeConfirmModalï¼Œè²»äº‹æ’­éŒ¯ Delete è²)
        document.getElementById('confirm-modal').style.display = 'none';

        // 3. è™•ç† PVP æŠ•é™é‚è¼¯
        if (gameMode === 'PVP' && currentRoomId) {
            const { ref, update } = window.firebaseModules;
            const opponentRole = (playerRole === 'host') ? 'guest' : 'host';
            
            // å¯«å…¥æ•¸æ“šï¼šè´å®¶æ˜¯å°æ‰‹ï¼ŒåŸå› ä¿‚æŠ•é™
            update(ref(db, 'rooms/' + currentRoomId), {
                winner: opponentRole,
                endReason: 'surrendered'
            });
        }

        // 4. é‡ç½®éŠæˆ²
        resetGame(); 
    }

function resetGame() {
        // 1. æ–·é–‹ Firebase é€£ç·š
        if (unsubscribeRoom) {
            unsubscribeRoom();
            unsubscribeRoom = null;
        }
        if (battleUnsubscribe) {
            battleUnsubscribe(); 
            battleUnsubscribe = null; 
        }
        // é¡å¤–ä¿éšª
        if (currentRoomId) {
             const { ref, off } = window.firebaseModules;
             off(ref(db, 'rooms/' + currentRoomId));
        }

        // 2. æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
        if (turnTimerInterval) clearInterval(turnTimerInterval);
        if (timerInterval) clearInterval(timerInterval);
        if (deploymentTimerInterval) clearInterval(deploymentTimerInterval);

        // æ¸…é™¤å¹½éˆè¨ˆæ™‚å™¨ (Timeout)
        if (typeof gameTimeouts !== 'undefined') {
             gameTimeouts.forEach(id => clearTimeout(id));
             gameTimeouts = [];
        }

        // 3. éš±è— UI å…ƒä»¶
        document.getElementById('turn-timer-container').style.display = 'none';
        document.getElementById('global-back-btn').style.display = 'none'; 
        document.getElementById('end-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'none'; 
        
        // 4. é¡¯ç¤º Start Screen
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('start-screen').style.opacity = '1';

        // 5. é‡ç½®è®Šæ•¸
        myGrid.fill(0);
        enemyGrid.fill(0);
        enemyShots = [];
        deployIndex = 0;
        currentPhase = 'DEPLOY';
        myDamage = 0;
        enemyDamage = 0;
        lastProcessedTimestamp = 0;

        if (typeof turnCounter !== 'undefined') {
            turnCounter = 0;
            const turnDisplay = document.getElementById('turn-count');
            if(turnDisplay) turnDisplay.innerText = "1"; 
        }

        // 6. é‡ç½® æ£‹ç›¤ & å´é‚Šæ¬„
        createGrid('player-grid');
        createGrid('enemy-grid');
        
        // â˜… é—œéµä¿®å¾©ï¼šå¼·åˆ¶å°‡é¡é ­è½‰å› My Fleet (ç©å®¶æ£‹ç›¤) â˜…
        // å¦‚æœå””åŠ å‘¢å…©å¥ï¼ŒAbort å®Œä¹‹å¾Œä½ å¯èƒ½æœƒæœ›ä½å€‹ç©ºçš„æ•µäººæ£‹ç›¤ï¼Œå’©éƒ½åšå””åˆ°
        document.getElementById('player-board').classList.add('active');
        document.getElementById('enemy-board').classList.remove('active');

        // é¡¯ç¤ºç•ªå´é‚Šæ¬„ (Sidebar)
        const sidebar = document.getElementById('fleet-sidebar');
        if(sidebar) sidebar.style.display = 'flex'; 
        document.getElementById('deploy-controls').style.display = 'inline'; 
        
        renderSidebar(); 
        
        // 7. é‡ç½®æ–‡å­— & æŒ‰éˆ•
        document.getElementById('game-status').innerHTML = `PHASE: <span style="color: var(--warning);">DEPLOYMENT</span>`;
        document.getElementById('control-panel').style.borderColor = "var(--primary)";
        document.getElementById('start-btn').disabled = true;
        
        // 8. é‡ç½®è‰¦éšŠè¨­å®š
        FLEET.forEach(ship => {
            ship.indices = null;
            ship.revealed = false; 
        });
        placeEnemyShips();
    }

function handleTurnTimeout() {
        document.getElementById('turn-timer-container').style.display = 'none';
        playSound('timeout-sfx');
        
        const status = document.getElementById('game-status');
        status.innerHTML = `PHASE: <span style="color:var(--danger)">TOO SLOW! TURN SKIPPED</span>`;
        document.getElementById('control-panel').style.borderColor = "var(--danger)";

        if (gameMode === 'PVP') {
            const { ref, update } = window.firebaseModules;
            update(ref(db, 'rooms/' + currentRoomId), {
                lastMove: { attacker: playerRole, index: -1, timestamp: Date.now() }
            });
            
            currentPhase = 'ENEMY_TURN';
            // â˜… æ”¹ç”¨ setGameTimeout â˜…
            setGameTimeout(() => {
                document.getElementById('game-status').innerHTML = "OPPONENT'S TURN";
                switchScene('ENEMY');
            }, 1500);
        } else {
            // â˜… æ”¹ç”¨ setGameTimeout â˜…
            setGameTimeout(startEnemyTurn, 1500);
        }
    }
function startDeploymentTimer() {
        const barContainer = document.getElementById('turn-timer-container');
        const bar = document.getElementById('turn-timer-bar');
        const status = document.getElementById('game-status');
        
        barContainer.style.display = 'block';
        bar.style.width = '100%';
        
        let timeLeft = 60.0; 
        
        if (deploymentTimerInterval) clearInterval(deploymentTimerInterval);
        
        deploymentTimerInterval = setInterval(() => {
            timeLeft -= 0.1;
            const percentage = (timeLeft / 60.0) * 100;
            bar.style.width = percentage + "%";
            
            // â˜… ä¿®æ”¹é‡é»ï¼šé€™è£¡çµ±ä¸€é¡¯ç¤ºã€Œé€²åº¦ã€åŒã€Œæ™‚é–“ã€ â˜…
            // æ ¼å¼ï¼šDEPLOY: SHIP 1/4 [ 59s ]
            let currentShipNum = Math.min(deployIndex + 1, FLEET.length);
            let timeStr = Math.ceil(timeLeft);
            
            status.innerHTML = `DEPLOY: SHIP ${currentShipNum}/${FLEET.length} <span style="color:var(--warning); margin-left:10px;">[ ${timeStr}s ]</span>`;

            if (timeLeft <= 0) {
                clearInterval(deploymentTimerInterval);
                handleDeploymentTimeout(); 
            }
        }, 100);
    }
function handleDeploymentTimeout() {
        playSound('timeout-sfx');
        const status = document.getElementById('game-status');
        status.innerHTML = `TIME'S UP! AUTO-DEPLOYING...`;
        
        for (let i = 0; i < FLEET.length; i++) {
            if (!FLEET[i].indices) {
                let placed = false;
                while (!placed) {
                    let r = Math.floor(Math.random() * 100);
                    let v = Math.random() > 0.5;
                    let idxs = getShipIndices(r, FLEET[i], v);
                    
                    if (idxs && !idxs.some(x => myGrid[x] === 1)) {
                        idxs.forEach(x => myGrid[x] = 1);
                        FLEET[i].indices = idxs;
                        placeShipImage('player-grid', r, FLEET[i], v);
                        const unit = document.getElementById(`ship-unit-${i}`);
                        if (unit) {
                            unit.classList.remove('pending', 'current');
                            unit.classList.add('deployed');
                        }
                        placed = true;
                    }
                }
            }
        }
        
        deployIndex = FLEET.length; 
        document.getElementById('start-btn').disabled = false;
        
        // â˜… æ”¹ç”¨ setGameTimeout â˜…
        setGameTimeout(() => {
            startBattle();
        }, 1000);
    }
// é¡¯ç¤ºé«˜ç§‘æŠ€é€šçŸ¥æ¡†
    function showNotification(text, type = 'success') {
        const box = document.getElementById('tech-notification');
        const title = document.getElementById('notif-title');
        const content = document.getElementById('notif-content');

        // è¨­å®šå…§å®¹
        content.innerText = text;
        
        // è¨­å®šé¡è‰² (ç¶ è‰²=Success, ç´…è‰²=Alert)
        if (type === 'success') {
            box.style.borderColor = 'var(--success)';
            title.style.color = 'var(--success)';
            title.innerText = "SYSTEM // CONNECTED";
            playSound('deploy-sfx'); // æ’­æ”¾éŸ³æ•ˆ
        } else {
            box.style.borderColor = 'var(--danger)';
            title.style.color = 'var(--danger)';
            title.innerText = "SYSTEM // ALERT";
            playSound('wrong-sfx');
        }

        // é¡¯ç¤º (æ»‘ä¸‹ä¾†)
        box.classList.add('active');

        // 3ç§’å¾Œè‡ªå‹•æ”¶ç•ªåŸ‹å»
        setTimeout(() => {
            box.classList.remove('active');
        }, 3000);
    }
// è¨­å®šã€Œæ–·ç·šéºå›‘ã€
    function setupDisconnectHandler() {
        const { ref, onDisconnect, update } = window.firebaseModules;
        const roomRef = ref(db, 'rooms/' + currentRoomId);
        
        // å°æ‰‹æ˜¯èª°ï¼Ÿ
        const opponentRole = (playerRole === 'host') ? 'guest' : 'host';

        // è¨­å®š onDisconnectï¼šå¦‚æœæˆ‘æ–·ç·šï¼ŒUpdate æˆ¿é–“æ•¸æ“šï¼Œåˆ¤å°æ–¹è´
        onDisconnect(roomRef).update({
            winner: opponentRole,
            endReason: 'disconnected'
        });
    }

    function processEnemyFleetData(shipsData) {
        enemyFleetData = [];
        if(!shipsData) return;
        
        shipsData.forEach(ship => {
            if(!ship.indices) return;
            const root = ship.indices[0];
            
            // â˜… é—œéµï¼šå„ªå…ˆè®€å–å‚³éä¾†çš„ isVertical â˜…
            let isV = ship.isVertical;
            
            // å¦‚æœå°æ–¹æ˜¯èˆŠç‰ˆ (ç„¡å‚³éä¾†)ï¼Œæ‰ç”¨ä¼°ç®—
            if (typeof isV === 'undefined') {
                if (ship.indices.length > 1) {
                    isV = (ship.indices[1] === root + 10);
                } else {
                    isV = false;
                }
            }
            
            enemyFleetData.push({
                shipId: ship.shipId, 
                indices: ship.indices,
                conf: FLEET[ship.shipId], 
                rootIndex: root,
                isVertical: isV, // <-- å„²å­˜æ­£ç¢ºæ–¹å‘
                revealed: false
            });
        });
    }

  // 2. æª¢æŸ¥æˆ°è‰¦æ˜¯å¦å…¨æ»… (ä¿®æ”¹ç‰ˆï¼šæœƒå›å‚³ true/false)
    function checkEnemyShipDestruction(hitIdx) {
        const ship = enemyFleetData.find(s => s.indices.includes(hitIdx));
        if (!ship || ship.revealed) return false; // ç„¡èˆ¹æˆ–å·²ç¾å½¢

        // æª¢æŸ¥è©²èˆ¹æ‰€æœ‰éƒ¨åˆ†æ˜¯å¦éƒ½å·²ç¶“ä¿‚ 'hit'
        const allHit = ship.indices.every(idx => {
            const cell = document.getElementById('enemy-grid').children[idx];
            return cell.classList.contains('hit');
        });

        if (allHit) {
            revealEnemyShip(ship);
updateEnemyIndicator(ship.shipId);
            return true; // â˜… é—œéµï¼šå›å‚³ã€Œä¿‚ï¼Œæ²‰å’—ï¼ã€
        }
        return false; // æœªæ²‰
    }


// â˜… æœ€çµ‚ä¿®æ­£ç‰ˆï¼šé¡¯ç¤ºæ•µè»æˆ°è‰¦æ®˜éª¸ (åŠ å…¥æ™ºèƒ½æ¸¬é‡ï¼Œè§£æ±º Guest æ‰“äººæ™‚æ®˜éª¸ç§»ä½) â˜…
    function revealEnemyShip(ship) {
        ship.revealed = true;
        const board = document.getElementById('enemy-grid');
        const container = document.getElementById('enemy-board'); // â˜… ç›®æ¨™æ˜¯æ•µäººæ£‹ç›¤

        // å®‰å…¨æª¢æŸ¥
        if (!ship.rootIndex && ship.rootIndex !== 0) return;
        const startCell = board.children[ship.rootIndex];
        if (!startCell) return;

        // --- 1. æ™ºèƒ½æ¸¬é‡ (Smart Measurement) ---
        // æª¢æŸ¥æ•µäººæ£‹ç›¤ä¿‚å’ªé¡¯ç¤ºç·Šã€‚å¦‚æœä¸è¦‹äº†ï¼Œå°±å·å·æ‰“é–‹ä½¢é»åº¦ä½ã€‚
        const isVisible = (container.offsetParent !== null);
        let prevDisplay = '';
        let prevVisibility = '';

        if (!isVisible) {
            prevDisplay = container.style.display;
            prevVisibility = container.style.visibility;
            
            container.style.visibility = 'hidden'; // éš±å½¢
            container.style.display = 'block';     // ä½”ä½ (æ’é–‹ Grid)
            // çµ•ä¸ä½¿ç”¨ position: absoluteï¼Œä»¥å…å¯¬åº¦å¡Œé™·
        }

        // 2. è®€å–çœŸå¯¦åº§æ¨™ & å¤§ç´°
        const cellLeft = startCell.offsetLeft;
        const cellTop = startCell.offsetTop;
        const cellSize = startCell.offsetWidth; // â˜… æ”¹ç”¨å‹•æ…‹è®€å– (æ›´æº–ç¢º)

        // 3. é‚„åŸç‹€æ…‹
        if (!isVisible) {
            container.style.display = prevDisplay;
            container.style.visibility = prevVisibility;
        }

        // --- 4. å»ºç«‹åœ–ç‰‡ ---
        const img = document.createElement('img');
        
        // åœ–ç‰‡ä¾†æºè¨­å®š
        if (typeof DAMAGED_IMAGES !== 'undefined' && DAMAGED_IMAGES[ship.shipId]) {
            img.src = DAMAGED_IMAGES[ship.shipId];
        } else {
            img.src = ship.conf.img; 
        }
        
        img.classList.add('enemy-ship-revealed'); 
        
        const conf = ship.conf;
        // â˜… æ”¹ç”¨ cellSize è¨ˆç®—ï¼Œç¢ºä¿åŒæ ¼ä»”ä¸€æ¨£å¤§ â˜…
        const pW = cellSize * conf.width + 2 * (conf.width - 1);
        const pH = cellSize * conf.height + 2 * (conf.height - 1);
        
        img.style.width = pW + 'px'; 
        img.style.height = pH + 'px';
        
        // â˜… æ‡‰ç”¨æ­£ç¢ºåº§æ¨™ â˜…
        img.style.left = cellLeft + 'px';
        img.style.top = cellTop + 'px';
        
        // Transform ä¿®æ­£
        if (!ship.isVertical) {
            const shift = (pH - pW) / 2;
            img.style.transform = `translate(${shift}px, -${shift}px) rotate(-90deg)`;
        } else {
            img.style.transform = 'none';
        }
        
        board.appendChild(img);
        
        playSound('destroy-sfx'); 
        showNotification("ENEMY SHIP DESTROYED!", "success");
        
        // å¦‚æœæœ‰ç‹€æ…‹æ¬„ï¼Œé †ä¾¿æ›´æ–°åŸ‹
        if(typeof updateEnemyIndicator === 'function') {
             updateEnemyIndicator(ship.shipId);
        }
    }
</script>
</body>

</html>













